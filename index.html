<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeImagePDFTools</title>
    <meta name="description" content="Free online tools for image compression, resizing, conversion (JPG, PNG, WebP), interactive cropping, rotation, filters, JPG to PDF, and PDF to JPG. Optimize photos, manage files, and discover future PDF tools.">
    <meta name="keywords" content="online tools, free tools, image compressor, image resizer, image converter, JPG, PNG, WebP, image crop, rotate image, image filters, JPG to PDF, PDF to JPG, PDF tools, optimize photos">
    <meta name="author" content="FreeImagePDFTools">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <meta property="og:title" content="FreeImagePDFTools | Free Image & PDF Tools">
    <meta property="og:description" content="Free online tools for image compression, resizing, conversion, cropping, filters, JPG to PDF, PDF to JPG, and more.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="YOUR_WEBSITE_URL_HERE">

    <style>
        /* --- General & Layout Styles --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --info-color: #17a2b8; /* This is the color used by menu links */
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a3a; /* Slightly darker for contrast */
            --white-color: #fff;
            --gray-color: #6c757d;
            --border-radius: 0.5rem; /* Increased border-radius */
            --padding-base: 1rem;
            --margin-base: 1rem;
            --section-spacing: 3rem; /* Space between tool sections */
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: var(--dark-color);
            padding-top: 60px; /* Add padding equal to header height */
        }

        header {
            background-color: var(--dark-color);
            color: var(--white-color);
            padding: 0.8rem var(--padding-base);
            position: fixed; /* Fixed header */
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000; /* Ensure header is on top */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header .container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--padding-base);
            box-shadow: none;
            gap: 2rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--info-color);
        }

         header nav ul {
             list-style: none;
             margin: 0;
             padding: 0;
             display: flex;
             gap: 1rem;
         }

         header nav a {
             color: var(--info-color);
             text-decoration: none;
             font-weight: bold;
             transition: color 0.3s ease;
         }

         header nav a:hover {
             color: var(--white-color);
         }

        .container {
            max-width: 1200px;
            margin: var(--margin-base) auto;
            padding: var(--padding-base);
            background-color: var(--white-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
        }

        h1, h2, h3 {
            color: var(--dark-color);
            margin-bottom: var(--padding-base);
            text-align: center;
        }
        header h1 { color: var(--info-color); }
        h2 { margin-top: 0; }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        a:hover { text-decoration: underline; color: #0056b3; }

        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1rem;
            line-height: 1.5;
            vertical-align: middle;
            text-decoration: none;
        }
        .btn:hover { background-color: #0056b3; color: var(--white-color); transform: translateY(-2px); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-secondary:hover { background-color: #545b62; color: var(--white-color); }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-success:hover { background-color: #218838; color: var(--white-color); }
        .btn:disabled { background-color: #cccccc; color: #666; cursor: not-allowed; transform: none; }

        .alert { padding: var(--padding-base); margin-bottom: var(--margin-base); border-radius: var(--border-radius); }
        .alert-info { background-color: var(--info-color); color: var(--white-color); }

        main > section { display: none; }

        .ad-container {
            width: 100%; margin: 2rem auto; text-align: center; background-color: var(--light-color);
            padding: 1rem; border: 1px dashed var(--gray-color); min-height: 100px;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.9rem; color: var(--gray-color);
        }

        .tool-controls {
            margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 1rem;
            align-items: center; justify-content: center;
        }
        .tool-controls label { font-weight: bold; margin-right: 10px; }

        .file-input-container { margin-bottom: 1.5rem; text-align: center; }
        .drop-zone {
            border: 2px dashed var(--primary-color); border-radius: var(--border-radius); padding: 2rem;
            text-align: center; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s ease;
            color: var(--gray-color); max-width: 500px; margin: 1rem auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px;
        }
        .drop-zone.drag-over { background-color: rgba(0, 123, 255, 0.05); border-color: var(--primary-color); }
        input[type="file"] { display: none; }
        .drop-zone label { margin-top: 1rem; color: var(--primary-color); cursor: pointer; font-weight: bold; }
        .drop-zone label:hover { text-decoration: underline; }

        .image-info, .output-info, .file-list-display {
            margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1.5rem; display: none;
        }
        .image-info p, .output-info p, .file-list-display p { margin: 0.5rem 0; }
        .file-list-display ul { list-style: decimal; padding-left: 20px; text-align: left; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: var(--border-radius);}
        .file-list-display li { margin-bottom: 0.3rem; font-size: 0.9rem; }


        .image-preview {
            margin-top: 1.5rem; text-align: center; padding-top: 1.5rem;
            border-top: 1px solid #eee; display: none;
        }
        .preview-comparison { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 1rem; }
        .preview-comparison > div { flex: 1 1 300px; max-width: 50%; text-align: center; }
        .image-preview img {
            max-width: 100%; height: auto; border: 1px solid #ddd; padding: 5px;
            background-color: var(--white-color); box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
            display: none; margin: 0 auto; border-radius: var(--border-radius);
        }
        .preview-comparison img { display: block; }
        .preview-comparison .preview-label { font-weight: bold; margin-bottom: 0.5rem; display: block; }

        .download-section { margin-top: 1.5rem; text-align: center; }
        .download-section a { margin-top: var(--margin-base); }
        .processing-message { text-align: center; margin-top: 1rem; font-style: italic; color: var(--gray-color); display: none; }

        input[type="range"] { width: 80%; max-width: 400px; vertical-align: middle; flex-grow: 1; min-width: 150px; }
        .dimension-inputs, .crop-inputs { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: center; }
        .dimension-inputs input[type="number"], .crop-inputs input[type="number"] { width: 80px; padding: 0.5rem; border: 1px solid #ccc; border-radius: var(--border-radius); text-align: center; vertical-align: middle; }
        .dimension-inputs span, .crop-inputs span { vertical-align: middle; }
        .dimension-inputs label, .crop-inputs label { margin-right: 0; }

        .convert-controls select { padding: 0.5rem; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; vertical-align: middle; }
        .rotate-flip-controls, .filter-controls { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: center; }
        .filter-controls select { padding: 0.5rem; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 1rem; cursor: pointer; vertical-align: middle; }

        #cropImagePreview .cropper-container { position: relative; display: inline-block; max-width: 100%; vertical-align: top; }
        #cropImagePreview .cropper-container img { display: block; max-width: 100%; height: auto; border: 1px solid #ddd; padding: 5px; background-color: var(--white-color); box-shadow: 0 0 8px rgba(0, 0, 0, 0.05); border-radius: var(--border-radius); }
        #cropImagePreview .crop-selection-overlay { position: absolute; top: 0; left: 0; width: 0; height: 0; border: 1px dashed var(--primary-color); background-color: rgba(0, 123, 255, 0.1); box-sizing: border-box; pointer-events: none; display: none; z-index: 10; }

        #homepage-section .hero { text-align: center; margin-bottom: 2rem; padding: 2rem 1rem; background-color: var(--info-color); color: var(--white-color); border-radius: var(--border-radius); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
        #homepage-section .hero h2 { color: var(--white-color); margin-top: 0; font-size: 1.8rem; }
        #homepage-section .hero p { font-size: 1.1rem; }
        #homepage-section .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 1.5rem; }
        #homepage-section .tool-card { border: 1px solid #ddd; border-radius: var(--border-radius); padding: var(--padding-base); text-align: center; background-color: var(--white-color); transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        #homepage-section .tool-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .tool-card .icon-container { font-size: 3rem; margin-bottom: 0.5rem; color: var(--primary-color); }
        #homepage-section .tool-card h3 { margin-top: 0; font-size: 1.3rem; }
        #homepage-section .tool-card h3 a { color: inherit; text-decoration: none; }
        #homepage-section .tool-card h3 a:hover { text-decoration: underline; color: var(--primary-color); }
        #homepage-section .tool-card p { font-size: 0.95rem; color: var(--gray-color); flex-grow: 1; margin-bottom: 1rem; }
        #homepage-section .tool-card .tool-link { margin-top: auto; display: block; }

        #about-section h2, #contact-section h2, #privacy-section h2 { margin-bottom: 1.5rem; }
        #about-section p, #privacy-section p { margin-bottom: 1rem; text-align: justify; }
        #contact-section form { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 1rem; }
        #contact-section label { font-weight: bold; margin-bottom: 0.2rem; }
        #contact-section input[type="text"], #contact-section input[type="email"], #contact-section textarea { padding: 0.7rem; border: 1px solid #ccc; border-radius: var(--border-radius); font-size: 1rem; width: 100%; box-sizing: border-box; }
        #contact-section textarea { min-height: 150px; resize: vertical; }
        #contact-section button[type="submit"] { align-self: center; margin-top: 0.5rem; }

        footer { margin-top: 2rem; padding: 1.5rem var(--padding-base); background-color: var(--dark-color); color: var(--white-color); text-align: center; }
        footer p { margin: 0.5rem 0; }
        footer a { color: var(--info-color); }

        @media (max-width: 768px) {
            body { padding-top: 100px; }
            header .container { flex-direction: column; gap: 0.5rem; align-items: center; justify-content: center; }
            header h1 { text-align: center; }
            header nav ul { flex-direction: column; gap: 0.5rem; align-items: center; }
            .container { padding: var(--padding-base); margin: var(--padding-base); }
            .container h1 { color: var(--dark-color); font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            #homepage-section .hero h2 { font-size: 1.6rem; }
            .tool-controls { flex-direction: column; align-items: stretch; justify-content: flex-start; }
            .tool-controls label { margin-bottom: 0.5rem; margin-right: 0; }
            input[type="range"] { width: 100%; max-width: none; }
            .dimension-inputs, .crop-inputs { flex-direction: column; align-items: stretch; }
            .dimension-inputs input[type="number"], .crop-inputs input[type="number"] { width: 100%; box-sizing: border-box; }
            .convert-controls select { width: 100%; box-sizing: border-box; }
            .rotate-flip-controls, .filter-controls { flex-direction: column; align-items: stretch; }
            .rotate-flip-controls button, .filter-controls button, .filter-controls select { width: 100%; box-sizing: border-box; }
            .preview-comparison { flex-direction: column; gap: var(--padding-base); }
            .preview-comparison > div { flex: none; width: 100%; max-width: none; }
            #contact-section form { padding: 0 1rem; }
            .drop-zone { max-width: 100%; padding: 1.5rem; }
        }
    </style>

    <script type="application/ld+json">
    { "@context": "https://schema.org", "@type": "WebSite", "name": "FreeImagePDFTools", "url": "YOUR_WEBSITE_URL_HERE" }
    </script>
</head>
<body>

    <header>
        <div class="container">
            <div class="site-title"><a href="#homepage-section" style="text-decoration: none;"><h1>FreeImagePDFTools</h1></a></div>
            <nav>
                <ul>
                    <li><a href="#homepage-section">Home</a></li>
                    <li><a href="#about-section">About</a></li>
                    <li><a href="#contact-section">Contact</a></li>
                    <li><a href="#privacy-section">Privacy</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="homepage-section" class="container" data-aos="fade-up">
            <div class="hero">
                <h2>Unlock the Power of Free Online Tools</h2>
                <p>Discover our collection of easy-to-use tools for images, PDFs, and more!</p>
                 <a href="#image-compressor-section" class="btn">Get Started - Image Compressor</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (Homepage Top Ad)</p></div>
            <h3>Our Tools</h3>
            <div class="tools-grid">
                <div class="tool-card">
                    <div class="icon-container">üñºÔ∏è</div>
                    <h3><a href="#image-compressor-section">Image Compressor</a></h3>
                    <p>Quickly reduce the file size of your images (JPG, PNG) while maintaining quality.</p>
                    <a href="#image-compressor-section" class="tool-link btn">Use Tool</a>
                </div>
                <div class="tool-card">
                    <div class="icon-container">üìê</div>
                    <h3><a href="#image-resizer-section">Image Resizer</a></h3>
                    <p>Change the dimensions of your images to fit your needs by specifying width and height.</p>
                    <a href="#image-resizer-section" class="tool-link btn">Use Tool</a>
                </div>
                 <div class="tool-card">
                    <div class="icon-container">üîÑ</div>
                    <h3><a href="#image-converter-section">Image Converter</a></h3>
                    <p>Convert images between different formats like JPG, PNG, and WebP.</p>
                    <a href="#image-converter-section" class="tool-link btn">Use Tool</a>
                </div>
                 <div class="tool-card">
                     <div class="icon-container">‚úÇÔ∏è</div>
                    <h3><a href="#image-cropper-section">Image Cropper</a></h3>
                    <p>Select and crop a specific area of your image using your mouse.</p>
                    <a href="#image-cropper-section" class="tool-link btn">Use Tool</a>
                </div>
                 <div class="tool-card">
                     <div class="icon-container">‚Ü©Ô∏è</div>
                    <h3><a href="#image-rotate-flip-section">Rotate & Flip Image</a></h3>
                    <p>Rotate images by 90 degrees or flip them horizontally or vertically.</p>
                    <a href="#image-rotate-flip-section" class="tool-link btn">Use Tool</a>
                </div>
                 <div class="tool-card">
                     <div class="icon-container">‚ú®</div>
                    <h3><a href="#image-filters-section">Image Filters</a></h3>
                    <p>Apply basic filters like Grayscale to your images.</p>
                    <a href="#image-filters-section" class="tool-link btn">Use Tool</a>
                </div>
                <div class="tool-card">
                    <div class="icon-container">üñºÔ∏è‚û°Ô∏èüìÑ</div>
                    <h3><a href="#jpg-to-pdf-section">JPG to PDF</a></h3>
                    <p>Combine multiple JPG images into a single PDF file.</p>
                    <a href="#jpg-to-pdf-section" class="tool-link btn">Use Tool</a>
                </div>
                <div class="tool-card">
                    <div class="icon-container">üìÑ‚û°Ô∏èüñºÔ∏è</div>
                    <h3><a href="#pdf-to-jpg-section">PDF to JPG</a></h3>
                    <p>Convert each page of a PDF file into individual JPG images (as a ZIP).</p>
                    <a href="#pdf-to-jpg-section" class="tool-link btn">Use Tool</a>
                </div>
                 <div class="tool-card">
                    <div class="icon-container">üìÑ</div>
                    <h3><a href="#">Merge PDF</a></h3>
                    <p>Combine multiple PDF files into a single document.</p>
                    <a href="#" class="tool-link btn btn-secondary">Coming Soon</a>
                </div>
                 <div class="tool-card">
                    <div class="icon-container">üìÑ</div>
                    <h3><a href="#">Split PDF</a></h3>
                    <p>Extract specific pages or page ranges from a PDF.</p>
                    <a href="#" class="tool-link btn btn-secondary">Coming Soon</a>
                </div>
            </div>
            <div class="ad-container"><p>Advertisement Area (Homepage Bottom Ad)</p></div>
        </section>

        <section id="image-compressor-section" class="container" data-aos="fade-up">
            <h2>Online Image Compressor</h2>
            <p>Reduce the file size of your images without losing noticeable quality. Supports JPG, PNG, and WebP.</p>
            <div class="file-input-container">
                 <div id="compressDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="compressImageFile">Click to Upload Image</label>
                    <input type="file" id="compressImageFile" accept="image/*" aria-label="Select image file for compression">
                 </div>
            </div>
            <div class="tool-controls">
                <label for="compressionQuality">Compression Level:</label>
                <input type="range" id="compressionQuality" min="10" max="100" value="80">
                <span id="qualityValue">80%</span>
                <button id="compressNowBtn" class="btn" disabled>Compress Now</button>
            </div>
            <p id="compressProcessingMsg" class="processing-message">Processing...</p>
            <div class="ad-container"><p>Advertisement Area (Compressor Top Ad)</p></div>
            <div id="compressImageInfo" class="image-info">
                <h3>Compression Info</h3>
                <p><strong>Filename:</strong> <span id="compressOriginalFileName"></span></p>
                <p><strong>Original Size:</strong> <span id="compressOriginalSize"></span></p>
                <p><strong>New Size:</strong> <span id="compressedSize">-</span></p>
                <p><strong>Reduction:</strong> <span id="sizeReduction">-</span></p>
            </div>
            <div id="compressImagePreview" class="image-preview">
                 <h3>Preview</h3>
                 <div class="preview-comparison">
                     <div><span class="preview-label">Original</span><img id="originalImagePreview" src="" alt="Original Image Preview"></div>
                     <div><span class="preview-label">Compressed</span><img id="compressedImagePreview" src="" alt="Compressed Image Preview"></div>
                 </div>
            </div>
            <div class="download-section">
                 <p id="compressDownloadMessage" style="display: none;">Your compressed image is ready!</p>
                <a id="compressDownloadLink" class="btn btn-success" style="display: none;">Download Compressed Image</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (Compressor Bottom Ad)</p></div>
        </section>

        <section id="image-resizer-section" class="container" data-aos="fade-up">
            <h2>Online Image Resizer</h2>
            <p>Easily change the dimensions of your images.</p>
            <div class="file-input-container">
                 <div id="resizeDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="resizeImageFile">Click to Upload Image</label>
                    <input type="file" id="resizeImageFile" accept="image/*" aria-label="Select image file for resizing">
                 </div>
            </div>
            <div class="tool-controls dimension-inputs">
                 <label>New Dimensions:</label>
                 <input type="number" id="resizeWidth" placeholder="Width" min="1"><span>x</span>
                 <input type="number" id="resizeHeight" placeholder="Height" min="1">
                 <button id="applyResizeBtn" class="btn" disabled>Apply Resize</button>
            </div>
            <p id="resizeProcessingMsg" class="processing-message">Processing...</p>
            <div class="ad-container"><p>Advertisement Area (Resizer Top Ad)</p></div>
            <div id="resizeImageInfo" class="image-info">
                <h3>Resizer Info</h3>
                <p><strong>Filename:</strong> <span id="resizeOriginalFileName"></span></p>
                <p><strong>Original Dimensions:</strong> <span id="originalDimensions">-</span></p>
                <p><strong>New Dimensions:</strong> <span id="newDimensions">-</span></p>
                <p><strong>Original Size:</strong> <span id="resizeOriginalSize"></span></p>
                <p><strong>New Size:</strong> <span id="resizedSize">-</span></p>
            </div>
            <div id="resizeImagePreview" class="image-preview">
                 <h3>Preview</h3><img id="resizedImage" src="" alt="Resized Image Preview">
            </div>
            <div class="download-section">
                 <p id="resizeDownloadMessage" style="display: none;">Your resized image is ready!</p>
                <a id="resizeDownloadLink" class="btn btn-success" style="display: none;">Download Resized Image</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (Resizer Bottom Ad)</p></div>
        </section>

        <section id="image-converter-section" class="container" data-aos="fade-up">
            <h2>Online Image Converter</h2>
            <p>Convert your images between popular formats like JPG, PNG, and WebP.</p>
            <div class="file-input-container">
                 <div id="convertDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="convertImageFile">Click to Upload Image</label>
                    <input type="file" id="convertImageFile" accept="image/*" aria-label="Select image file for conversion">
                 </div>
            </div>
            <div class="tool-controls convert-controls">
                 <label for="outputFormat">Convert to:</label>
                 <select id="outputFormat">
                     <option value="image/jpeg">JPG</option><option value="image/png">PNG</option><option value="image/webp">WebP</option>
                 </select>
                 <button id="applyConvertBtn" class="btn" disabled>Convert Image</button>
            </div>
            <p id="convertProcessingMsg" class="processing-message">Processing...</p>
            <div class="ad-container"><p>Advertisement Area (Converter Top Ad)</p></div>
            <div id="convertImageInfo" class="image-info">
                <h3>Conversion Info</h3>
                <p><strong>Filename:</strong> <span id="convertOriginalFileName"></span></p>
                <p><strong>Original Format:</strong> <span id="originalFormat">-</span></p>
                <p><strong>New Format:</strong> <span id="newFormat">-</span></p>
                <p><strong>Original Size:</strong> <span id="convertOriginalSize"></span></p>
                <p><strong>New Size:</strong> <span id="convertedSize">-</span></p>
            </div>
            <div id="convertImagePreview" class="image-preview">
                 <h3>Preview</h3><img id="convertedImage" src="" alt="Converted Image Preview">
            </div>
            <div class="download-section">
                 <p id="convertDownloadMessage" style="display: none;">Your converted image is ready!</p>
                <a id="convertDownloadLink" class="btn btn-success" style="display: none;">Download Converted Image</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (Converter Bottom Ad)</p></div>
        </section>

        <section id="image-cropper-section" class="container" data-aos="fade-up">
            <h2>Online Image Cropper</h2>
            <p>Click "Select Area" and then click and drag on the image to select the crop area. Click "Crop" to process.</p>
            <div class="file-input-container">
                 <div id="cropDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="cropImageFile">Click to Upload Image</label>
                    <input type="file" id="cropImageFile" accept="image/*" aria-label="Select image file for cropping">
                 </div>
            </div>
            <div class="tool-controls">
                 <button id="selectCropAreaBtn" class="btn" disabled>Select Area</button>
                 <button id="cropAndDownloadBtn" class="btn" disabled>Crop</button>
            </div>
            <p id="cropProcessingMsg" class="processing-message">Processing...</p>
            <div id="cropImagePreview" class="image-preview">
                 <h3>Preview</h3>
                 <div class="cropper-container">
                     <img id="cropOriginalImagePreview" src="" alt="Image to Crop"><div class="crop-selection-overlay"></div>
                 </div>
                 <img id="croppedImage" src="" alt="Cropped Image Preview">
                 <div class="download-section">
                     <p id="cropDownloadMessage" style="display: none;">Your cropped image is ready!</p>
                    <a id="cropDownloadLink" class="btn btn-success" style="display: none;">Download Cropped Image</a>
                </div>
            </div>
            <div class="ad-container"><p>Advertisement Area (Cropper Top Ad)</p></div>
            <div id="cropImageInfo" class="image-info">
                <h3>Cropper Info</h3>
                <p><strong>Filename:</strong> <span id="cropOriginalFileName"></span></p>
                <p><strong>Original Dimensions:</strong> <span id="cropOriginalDimensions">-</span></p>
                <p><strong>Original Size:</strong> <span id="cropOriginalSize"></span></p>
                <p><strong>Cropped Dimensions:</strong> <span id="newCropDimensions">-</span></p>
                <p><strong>Cropped Size:</strong> <span id="croppedSize">-</span></p>
            </div>
            <div class="ad-container"><p>Advertisement Area (Cropper Bottom Ad)</p></div>
        </section>

        <section id="image-rotate-flip-section" class="container" data-aos="fade-up">
            <h2>Online Image Rotate & Flip</h2>
            <p>Rotate your image by 90 degrees or flip it horizontally or vertically.</p>
            <div class="file-input-container">
                 <div id="rotateFlipDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="rotateFlipImageFile">Click to Upload Image</label>
                    <input type="file" id="rotateFlipImageFile" accept="image/*" aria-label="Select image file for rotate/flip">
                 </div>
            </div>
            <div class="tool-controls rotate-flip-controls">
                 <button id="rotateLeftBtn" class="btn" disabled>Rotate Left 90¬∞</button>
                 <button id="rotateRightBtn" class="btn" disabled>Rotate Right 90¬∞</button>
                 <button id="flipHorizontalBtn" class="btn" disabled>Flip Horizontal</button>
                 <button id="flipVerticalBtn" class="btn" disabled>Flip Vertical</button>
            </div>
            <p id="rotateFlipProcessingMsg" class="processing-message">Processing...</p>
            <div class="ad-container"><p>Advertisement Area (Rotate/Flip Top Ad)</p></div>
            <div id="rotateFlipImageInfo" class="image-info">
                <h3>Result Info</h3>
                <p><strong>Filename:</strong> <span id="rotateFlipOriginalFileName"></span></p>
                <p><strong>Original Dimensions:</strong> <span id="originalRotateFlipDimensions">-</span></p>
                <p><strong>Original Size:</strong> <span id="rotateFlipOriginalSize"></span></p>
                <p><strong>New Dimensions:</strong> <span id="newRotateFlipDimensions">-</span></p>
                <p><strong>New Size:</strong> <span id="newRotateFlipSize">-</span></p>
            </div>
            <div id="rotateFlipImagePreview" class="image-preview">
                 <h3>Preview</h3><img id="rotatedFlippedImage" src="" alt="Rotated/Flipped Image Preview">
            </div>
            <div class="download-section">
                 <p id="rotateFlipDownloadMessage" style="display: none;">Your image is ready!</p>
                <a id="rotateFlipDownloadLink" class="btn btn-success" style="display: none;">Download Image</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (Rotate/Flip Bottom Ad)</p></div>
        </section>

        <section id="image-filters-section" class="container" data-aos="fade-up">
            <h2>Online Image Filters</h2>
            <p>Apply filters to your image.</p>
            <div class="file-input-container">
                 <div id="filterDropZone" class="drop-zone">
                    <p>Drag & Drop your image here</p><p>or</p>
                    <label for="filterImageFile">Click to Upload Image</label>
                    <input type="file" id="filterImageFile" accept="image/*" aria-label="Select image file for filtering">
                 </div>
            </div>
            <div class="tool-controls filter-controls">
                 <label for="filterType">Select Filter:</label>
                 <select id="filterType" disabled>
                     <option value="none">None</option><option value="grayscale">Grayscale</option>
                     <option value="sepia">Sepia</option><option value="invert">Invert</option>
                     <option value="red">Red Channel</option><option value="green">Green Channel</option><option value="blue">Blue Channel</option>
                 </select>
                 <button id="applyFilterBtn" class="btn" disabled>Apply Filter</button>
            </div>
            <p id="filterProcessingMsg" class="processing-message">Processing...</p>
            <div class="ad-container"><p>Advertisement Area (Filters Top Ad)</p></div>
            <div id="filterImageInfo" class="image-info">
                <h3>Result Info</h3>
                <p><strong>Filename:</strong> <span id="filterOriginalFileName"></span></p>
                <p><strong>Original Dimensions:</strong> <span id="originalFilterDimensions">-</span></p>
                <p><strong>Original Size:</strong> <span id="filterOriginalSize"></span></p>
                <p><strong>New Size:</strong> <span id="newFilterSize">-</span></p>
            </div>
            <div id="filterImagePreview" class="image-preview">
                 <h3>Preview</h3><img id="filteredImage" src="" alt="Filtered Image Preview">
                 <div class="download-section">
                     <p id="filterDownloadMessage" style="display: none;">Your filtered image is ready!</p>
                    <a id="filterDownloadLink" class="btn btn-success" style="display: none;">Download Image</a>
                </div>
            </div>
            <div class="ad-container"><p>Advertisement Area (Filters Bottom Ad)</p></div>
        </section>

        <!-- JPG to PDF Tool Section -->
        <section id="jpg-to-pdf-section" class="container" data-aos="fade-up">
            <h2>JPG to PDF Converter</h2>
            <p>Convert multiple JPG images into a single PDF document.</p>
            <div class="file-input-container">
                <div id="jpgToPdfDropZone" class="drop-zone">
                    <p>Drag & Drop your JPG images here</p><p>or</p>
                    <label for="jpgToPdfFilesInput">Click to Upload JPGs</label>
                    <input type="file" id="jpgToPdfFilesInput" accept="image/jpeg,image/jpg" multiple aria-label="Select JPG files for PDF conversion">
                </div>
            </div>
            <div id="jpgToPdfFileList" class="file-list-display">
                <h4>Selected JPG Files:</h4>
                <ul id="jpgToPdfFilesListUl"></ul>
            </div>
            <div class="tool-controls">
                <button id="convertToPdfBtn" class="btn" disabled>Convert to PDF</button>
            </div>
            <p id="jpgToPdfProcessingMsg" class="processing-message">Processing... This may take a moment for many images.</p>
            <div class="ad-container"><p>Advertisement Area (JPG to PDF Top Ad)</p></div>
            <div id="jpgToPdfOutputInfo" class="output-info">
                <h3>Conversion Result</h3>
                <p><span id="jpgToPdfResultText"></span></p>
            </div>
            <div class="download-section">
                <p id="jpgToPdfDownloadMessage" style="display: none;">Your PDF is ready!</p>
                <a id="jpgToPdfDownloadLink" class="btn btn-success" style="display: none;">Download PDF</a>
            </div>
            <div class="ad-container"><p>Advertisement Area (JPG to PDF Bottom Ad)</p></div>
        </section>

        <!-- PDF to JPG Tool Section -->
        <section id="pdf-to-jpg-section" class="container" data-aos="fade-up">
            <h2>PDF to JPG Converter</h2>
            <p>Convert each page of a PDF file into individual JPG images, downloaded as a ZIP file.</p>
            <div class="file-input-container">
                <div id="pdfToJpgDropZone" class="drop-zone">
                    <p>Drag & Drop your PDF file here</p><p>or</p>
                    <label for="pdfToJpgFileInput">Click to Upload PDF</label>
                    <input type="file" id="pdfToJpgFileInput" accept="application/pdf" aria-label="Select PDF file for JPG conversion">
                </div>
            </div>
            <div id="pdfToJpgFileInfo" class="image-info"> <!-- Re-using image-info for consistency -->
                <h3>Selected PDF File:</h3>
                <p><strong>Filename:</strong> <span id="pdfToJpgFileName"></span></p>
                <p><strong>Size:</strong> <span id="pdfToJpgFileSize"></span></p>
            </div>
            <div class="tool-controls">
                <button id="convertToJpgsBtn" class="btn" disabled>Convert to JPGs</button>
            </div>
            <p id="pdfToJpgProcessingMsg" class="processing-message">Processing PDF... This can take some time for large PDFs.</p>
             <div class="ad-container"><p>Advertisement Area (PDF to JPG Top Ad)</p></div>
            <div id="pdfToJpgOutputInfo" class="output-info">
                <h3>Conversion Result</h3>
                <p><span id="pdfToJpgResultText"></span></p>
            </div>
            <div class="download-section">
                <p id="pdfToJpgDownloadMessage" style="display: none;">Your JPG images (ZIP) are ready!</p>
                <a id="pdfToJpgDownloadLink" class="btn btn-success" style="display: none;">Download JPGs (ZIP)</a>
            </div>
             <div class="ad-container"><p>Advertisement Area (PDF to JPG Bottom Ad)</p></div>
        </section>


        <section id="about-section" class="container" data-aos="fade-up">
            <h2>About Us</h2>
            <p>Welcome to FreeImagePDFTools, your one-stop destination for free and easy-to-use online image and PDF tools. Our mission is to provide simple, fast, and effective tools to help you manage your digital files without needing to download complex software.</p>
            <p>We are constantly working on adding new tools and improving the existing ones based on your feedback. Whether you need to compress images for your website, resize a photo for social media, convert formats (JPG, PNG, WebP), crop, rotate, flip, apply filters, or perform operations on PDF documents, we aim to make it as straightforward as possible.</p>
            <p>Thank you for using our tools!</p>
            <div class="ad-container"><p>Advertisement Area (About Page Ad)</p></div>
        </section>
        <section id="contact-section" class="container" data-aos="fade-up">
            <h2>Contact Us</h2>
            <p>Have questions, feedback, or suggestions for new tools? We'd love to hear from you!</p>
            <form id="contactForm" action="#" method="POST">
                <div><label for="name">Name:</label><input type="text" id="name" name="name" required></div>
                <div><label for="email">Email:</label><input type="email" id="email" name="email" required></div>
                <div><label for="message">Message:</label><textarea id="message" name="message" required></textarea></div>
                <button type="submit" class="btn">Send Message</button>
            </form>
            <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">(Note: This form is a placeholder and requires server-side integration to send emails.)</p>
            <div class="ad-container"><p>Advertisement Area (Contact Page Ad)</p></div>
        </section>
        <section id="privacy-section" class="container" data-aos="fade-up">
            <h2>Privacy Policy</h2>
            <p>Your privacy is important to us. This policy explains how we handle information on our website.</p>
            <h3>What information do we collect?</h3>
            <p>We do not collect any personally identifiable information from you unless you voluntarily provide it (e.g., via the contact form). Our tools process files entirely in your browser; your files are not uploaded to our servers.</p>
            <h3>How do we use your information?</h3>
            <p>Any information you provide via the contact form is used solely to respond to your inquiry. We do not share, sell, or rent your personal information to third parties.</p>
            <h3>Cookies and Tracking</h3>
            <p>We may use standard website tracking technologies (like Google Analytics - if implemented) to understand how the site is used in aggregate, which helps us improve our services. These tools typically collect non-personally identifiable information such as browser type, pages visited, and time spent on the site.</p>
            <p>Advertisement partners (like Google AdSense) may use cookies to serve ads based on your visit to this and other sites. You can opt out of personalized advertising by visiting Ads Settings.</p>
            <h3>Third-Party Links</h3>
            <p>This website may contain links to other sites. We are not responsible for the privacy practices or the content of such other sites.</p>
            <h3>Your Consent</h3>
            <p>By using our site, you consent to our privacy policy.</p>
            <h3>Changes to our Privacy Policy</h3>
            <p>If we decide to change our privacy policy, we will post those changes on this page.</p>
            <p>This policy was last updated on [Date - e.g., May 5, 2023].</p>
            <div class="ad-container"><p>Advertisement Area (Privacy Page Ad)</p></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2023 FreeImagePDFTools. All rights reserved.</p>
            <p><a href="#privacy-section">Privacy Policy</a>&nbsp;|&nbsp;<a href="#contact-section">Contact Us</a>&nbsp;|&nbsp;<a href="#about-section">About</a></p>
        </div>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- JSZip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- No need for separate pdf.worker.min.js if using CDN, pdf.min.js usually handles it or we set workerSrc -->


    <script>
        AOS.init({ duration: 800, easing: 'ease-in-out', once: true, mirror: false });

        function formatBytes(bytes, decimals = 2) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = bytes < 1 ? 0 : Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        let originalCompressImage = new Image();
        let originalResizeImage = new Image();
        let originalConvertImage = new Image();
        let originalCropImage = new Image();
        let originalRotateFlipImage = new Image();
        let currentRotateFlipImage = new Image();
        let originalFilterImage = new Image();

        window.originalCompressFile = null;
        window.originalResizeFile = null;
        window.originalConvertFile = null;
        window.originalCropFile = null;
        window.originalRotateFlipFile = null;
        window.originalFilterFile = null;
        window.originalJpgsForPdf = [];
        window.originalPdfForJpg = null;

        window.finalScaledCrop = null;

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        document.addEventListener('dragover', preventDefaults, false);
        document.addEventListener('drop', preventDefaults, false);

        document.addEventListener('DOMContentLoaded', () => {
            console.log("[GLOBAL] DOM fully loaded. Initializing...");
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
                console.log("[GLOBAL] PDF.js worker source configured.");
            } else {
                console.error("[GLOBAL] pdfjsLib is not defined. PDF to JPG tool may not work.");
            }

            const sections = document.querySelectorAll('main > section');
            const navLinks = document.querySelectorAll('header nav a, #homepage-section a.tool-link, #homepage-section .tool-card h3 a, footer a[href^="#"]');
            let currentActiveSectionId = null;

            function showSection(id) {
                console.log(`[NAV] Attempting to show section: ${id}`);
                if (currentActiveSectionId && currentActiveSectionId !== id) {
                    const nonToolSectionIds = ['homepage-section', 'about-section', 'contact-section', 'privacy-section'];
                    if (currentActiveSectionId.endsWith('-section') && !nonToolSectionIds.includes(currentActiveSectionId)) {
                        const toolIdToReset = currentActiveSectionId.replace('-section', '');
                        console.log(`[NAV] Navigating away from ${currentActiveSectionId}. Resetting tool: ${toolIdToReset}`);
                        resetToolState(toolIdToReset);
                    }
                }
                sections.forEach(section => { section.style.display = 'none'; });
                const targetSection = document.getElementById(id);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    document.querySelectorAll('header nav a').forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === '#' + id) { link.classList.add('active'); }
                    });
                    requestAnimationFrame(() => {
                        const headerHeight = document.querySelector('header')?.offsetHeight || 60;
                        const targetScrollTop = id === 'homepage-section' ? 0 : Math.max(0, targetSection.offsetTop - headerHeight);
                        window.scrollTo({ top: targetScrollTop, behavior: 'smooth' });
                    });
                    console.log(`[NAV] Section shown: ${id}`);
                    currentActiveSectionId = id;
                } else {
                    console.warn(`[NAV] Section with ID "${id}" not found. Showing homepage.`);
                    showSection('homepage-section');
                }
            }

            function handleNavigation() {
                const currentHash = window.location.hash;
                const targetId = currentHash ? currentHash.substring(1) : 'homepage-section';
                showSection(targetId);
            }

            function resetToolState(toolId) {
                 console.log(`[RESET] Attempting to reset tool: ${toolId}`);
                 const section = document.getElementById(toolId + '-section');
                 if (!section) { console.warn(`[RESET] Failed: Section for tool "${toolId}" not found.`); return; }

                 try {
                     const previewSection = section.querySelector('.image-preview');
                      const imagesToClean = previewSection ? previewSection.querySelectorAll('img') : [];
                      imagesToClean.forEach(img => {
                          if (img.src && img.src.startsWith('blob:')) {
                              console.log(`[RESET:${toolId}] Revoking Blob URL: ${img.src}`);
                              try { URL.revokeObjectURL(img.src); } catch (e) { console.error(`[RESET:${toolId}] Error revoking Blob URL ${img.src}:`, e); }
                          }
                          img.src = ''; img.style.display = 'none'; img.alt = '';
                      });
                      if (previewSection) previewSection.style.display = 'none';

                      const downloadSection = section.querySelector('.download-section');
                      const downloadLink = downloadSection ? downloadSection.querySelector('a.btn') : null;
                      if (downloadLink) {
                          if (downloadLink.href && downloadLink.href.startsWith('blob:')) {
                               console.log(`[RESET:${toolId}] Revoking Blob URL from download link: ${downloadLink.href}`);
                              try { URL.revokeObjectURL(downloadLink.href); } catch (e) { console.error(`[RESET:${toolId}] Error revoking Blob URL ${downloadLink.href}:`, e); }
                          }
                          downloadLink.href = '#'; downloadLink.style.display = 'none'; downloadLink.removeAttribute('download');
                      }
                      if (downloadSection) {
                          const downloadMessage = downloadSection.querySelector('p');
                          if(downloadMessage) downloadMessage.style.display = 'none';
                      }

                     const infoDiv = section.querySelector('.image-info, .output-info, .file-list-display');
                     if (infoDiv) infoDiv.style.display = 'none';
                     const processingMsg = section.querySelector('.processing-message');
                     if (processingMsg) processingMsg.style.display = 'none';

                     switch(toolId) {
                        case 'image-compressor':
                             const csSpan = section.querySelector('#compressedSize'); if(csSpan) csSpan.textContent = '-';
                             const srSpan = section.querySelector('#sizeReduction'); if(srSpan) srSpan.textContent = '-';
                             const qs = section.querySelector('#compressionQuality'); if(qs) qs.value = 80;
                             const qvSpan = section.querySelector('#qualityValue'); if(qvSpan) qvSpan.textContent = '80%';
                             const cnb = section.querySelector('#compressNowBtn'); if(cnb) cnb.disabled = true;
                             const cofnSpan = section.querySelector('#compressOriginalFileName'); if(cofnSpan) cofnSpan.textContent = '';
                             const cosSpan = section.querySelector('#compressOriginalSize'); if(cosSpan) cosSpan.textContent = '';
                             if (originalCompressImage.src && originalCompressImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalCompressImage.src); } catch (e) {} } originalCompressImage.src = ''; originalCompressImage.onload = null; originalCompressImage.onerror = null;
                             window.originalCompressFile = null;
                             break;
                        case 'image-resizer':
                             const odSpan = section.querySelector('#originalDimensions'); if(odSpan) odSpan.textContent = '-';
                             const ndSpan = section.querySelector('#newDimensions'); if(ndSpan) ndSpan.textContent = '-';
                             const rzSizeSpan = section.querySelector('#resizedSize'); if(rzSizeSpan) rzSizeSpan.textContent = '-';
                             const wi = section.querySelector('#resizeWidth'); if(wi) wi.value = '';
                             const hi = section.querySelector('#resizeHeight'); if(hi) hi.value = '';
                             const arb = section.querySelector('#applyResizeBtn'); if(arb) arb.disabled = true;
                             const rzosSpan = section.querySelector('#resizeOriginalSize'); if(rzosSpan) rzosSpan.textContent = '';
                             const rzofnSpan = section.querySelector('#resizeOriginalFileName'); if(rzofnSpan) rzofnSpan.textContent = '';
                             if (originalResizeImage.src && originalResizeImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalResizeImage.src); } catch (e) {} } originalResizeImage.src = ''; originalResizeImage.onload = null; originalResizeImage.onerror = null;
                             window.originalResizeFile = null;
                             break;
                        case 'image-converter':
                             const ofSpan = section.querySelector('#originalFormat'); if(ofSpan) ofSpan.textContent = '-';
                             const nfSpan = section.querySelector('#newFormat'); if(nfSpan) nfSpan.textContent = '-';
                             const cvSizeSpan = section.querySelector('#convertedSize'); if(cvSizeSpan) cvSizeSpan.textContent = '-';
                             const fos = section.querySelector('#outputFormat'); if(fos) fos.value = 'image/jpeg';
                             const acb = section.querySelector('#applyConvertBtn'); if(acb) acb.disabled = true;
                             const cvosSpan = section.querySelector('#convertOriginalSize'); if(cvosSpan) cvosSpan.textContent = '';
                             const cvofnSpan = section.querySelector('#convertOriginalFileName'); if(cvofnSpan) cvofnSpan.textContent = '';
                             if (originalConvertImage.src && originalConvertImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalConvertImage.src); } catch (e) {} } originalConvertImage.src = ''; originalConvertImage.onload = null; originalConvertImage.onerror = null;
                             window.originalConvertFile = null;
                             break;
                        case 'image-cropper':
                             const coDimSpan = section.querySelector('#cropOriginalDimensions'); if(coDimSpan) coDimSpan.textContent = '-';
                             const coszSpan = section.querySelector('#cropOriginalSize'); if(coszSpan) coszSpan.textContent = '-';
                             const ncDimSpan = section.querySelector('#newCropDimensions'); if(ncDimSpan) ncDimSpan.textContent = '-';
                             const crszSpan = section.querySelector('#croppedSize'); if(crszSpan) crszSpan.textContent = '-';
                             const cadb = section.querySelector('#cropAndDownloadBtn'); if(cadb) cadb.disabled = true;
                             const sab = section.querySelector('#selectCropAreaBtn'); if(sab) sab.disabled = true;
                             const crofnSpan = section.querySelector('#cropOriginalFileName'); if(crofnSpan) crofnSpan.textContent = '';
                             window.finalScaledCrop = null;
                             const co = section.querySelector('.crop-selection-overlay'); if (co) co.style.cssText = 'display: none; top: 0; left: 0; width: 0; height: 0;';
                             const cc = section.querySelector('.cropper-container'); if(cc) cc.style.cursor = 'default';
                             if (originalCropImage.src && originalCropImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalCropImage.src); } catch (e) {} } originalCropImage.src = ''; originalCropImage.onload = null; originalCropImage.onerror = null;
                             window.originalCropFile = null;
                             break;
                        case 'image-rotate-flip':
                             const orfDimSpan = section.querySelector('#originalRotateFlipDimensions'); if(orfDimSpan) orfDimSpan.textContent = '-';
                             const orfSizeSpan = section.querySelector('#rotateFlipOriginalSize'); if(orfSizeSpan) orfSizeSpan.textContent = '-';
                             const nrfDimSpan = section.querySelector('#newRotateFlipDimensions'); if(nrfDimSpan) nrfDimSpan.textContent = '-';
                             const nrfSizeSpan = section.querySelector('#newRotateFlipSize'); if(nrfSizeSpan) nrfSizeSpan.textContent = '-';
                             section.querySelectorAll('.rotate-flip-controls button').forEach(btn => btn.disabled = true);
                             const orffnSpan = section.querySelector('#rotateFlipOriginalFileName'); if(orffnSpan) orffnSpan.textContent = '';
                             if (originalRotateFlipImage.src && originalRotateFlipImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalRotateFlipImage.src); } catch (e) {} } originalRotateFlipImage.src = ''; originalRotateFlipImage.onload = null; originalRotateFlipImage.onerror = null;
                             if (currentRotateFlipImage.src && currentRotateFlipImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(currentRotateFlipImage.src); } catch (e) {} } currentRotateFlipImage.src = ''; currentRotateFlipImage.onload = null; currentRotateFlipImage.onerror = null;
                             window.originalRotateFlipFile = null;
                             break;
                        case 'image-filters':
                             const ofDimSpan = section.querySelector('#originalFilterDimensions'); if(ofDimSpan) ofDimSpan.textContent = '-';
                             const ofszSpan = section.querySelector('#filterOriginalSize'); if(ofszSpan) ofszSpan.textContent = '-';
                             const nfSizeSpan = section.querySelector('#newFilterSize'); if(nfSizeSpan) nfSizeSpan.textContent = '-';
                             const fis = section.querySelector('#filterType'); if(fis) { fis.value = 'none'; fis.disabled = true; }
                             const afb = section.querySelector('#applyFilterBtn'); if(afb) afb.disabled = true;
                             const offnSpan = section.querySelector('#filterOriginalFileName'); if(offnSpan) offnSpan.textContent = '';
                             if (originalFilterImage.src && originalFilterImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(originalFilterImage.src); } catch (e) {} } originalFilterImage.src = ''; originalFilterImage.onload = null; originalFilterImage.onerror = null;
                             window.originalFilterFile = null;
                             break;
                        case 'jpg-to-pdf':
                            const fileListUl = section.querySelector('#jpgToPdfFilesListUl'); if (fileListUl) fileListUl.innerHTML = '';
                            const fileListDisplay = section.querySelector('#jpgToPdfFileList'); if (fileListDisplay) fileListDisplay.style.display = 'none';
                            const convertToPdfBtn = section.querySelector('#convertToPdfBtn'); if (convertToPdfBtn) convertToPdfBtn.disabled = true;
                            const jpgToPdfResultText = section.querySelector('#jpgToPdfResultText'); if (jpgToPdfResultText) jpgToPdfResultText.textContent = '';
                            window.originalJpgsForPdf.forEach(fileObj => {
                                if (fileObj.url && fileObj.url.startsWith('blob:')) { try { URL.revokeObjectURL(fileObj.url); } catch(e){} }
                            });
                            window.originalJpgsForPdf = [];
                            break;
                        case 'pdf-to-jpg':
                            const pdfFileNameSpan = section.querySelector('#pdfToJpgFileName'); if (pdfFileNameSpan) pdfFileNameSpan.textContent = '';
                            const pdfFileSizeSpan = section.querySelector('#pdfToJpgFileSize'); if (pdfFileSizeSpan) pdfFileSizeSpan.textContent = '';
                            const pdfToJpgFileInfoDiv = section.querySelector('#pdfToJpgFileInfo'); if(pdfToJpgFileInfoDiv) pdfToJpgFileInfoDiv.style.display = 'none';
                            const convertToJpgsBtn = section.querySelector('#convertToJpgsBtn'); if (convertToJpgsBtn) convertToJpgsBtn.disabled = true;
                            const pdfToJpgResultText = section.querySelector('#pdfToJpgResultText'); if (pdfToJpgResultText) pdfToJpgResultText.textContent = '';
                             if (window.originalPdfForJpg && window.originalPdfForJpg.url && window.originalPdfForJpg.url.startsWith('blob:')) {
                                try { URL.revokeObjectURL(window.originalPdfForJpg.url); } catch(e) {}
                            }
                            window.originalPdfForJpg = null;
                            break;
                     }
                     const fileInput = section.querySelector('input[type="file"]');
                     if (fileInput) fileInput.value = '';
                     console.log(`[RESET] Finished resetting tool: ${toolId}`);
                 } catch (error) {
                     console.error(`[RESET] FATAL ERROR during reset of tool ${toolId}:`, error);
                 }
            }

            function addDropZoneListeners(toolId, dropZoneId, fileInputId, isMultiple = false, acceptType = "image/*") {
                const dropZone = document.getElementById(dropZoneId);
                const fileInput = document.getElementById(fileInputId);
                if (!dropZone || !fileInput) { console.error(`[LISTENERS] Missing elements for ${toolId}`); return; }

                ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, (e) => { preventDefaults(e); dropZone.classList.add('drag-over'); }));
                ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, (e) => { preventDefaults(e); dropZone.classList.remove('drag-over'); }));

                dropZone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (isMultiple) {
                            const validFiles = Array.from(files).filter(file => file.type.startsWith(acceptType.split('/')[0] + '/') || (acceptType === "application/pdf" && file.type === "application/pdf"));
                            if (validFiles.length > 0) handleFileSelection(validFiles, toolId, isMultiple);
                            else alert(`Please drop valid ${acceptType.split('/')[0].toUpperCase()} files for ${toolId}.`);
                        } else {
                            const file = files[0];
                            if (file.type.startsWith(acceptType.split('/')[0] + '/') || (acceptType === "application/pdf" && file.type === "application/pdf")) {
                                handleFileSelection(file, toolId, isMultiple);
                            } else {
                                alert(`Please drop a valid ${acceptType.toUpperCase()} file for ${toolId}.`);
                                resetToolState(toolId);
                            }
                        }
                    } else {
                         alert(`No file found in the drop data for ${toolId}.`);
                         resetToolState(toolId);
                    }
                });
                fileInput.addEventListener('change', (event) => {
                    const files = event.target.files;
                    if (files.length > 0) {
                        if (isMultiple) handleFileSelection(Array.from(files), toolId, isMultiple);
                        else handleFileSelection(files[0], toolId, isMultiple);
                    } else {
                        resetToolState(toolId);
                    }
                });
            }

            function handleFileSelection(selected, toolId, isMultiple) {
                resetToolState(toolId);
                if (isMultiple) {
                    if (toolId === 'jpg-to-pdf') {
                        // Filter only JPG/JPEG files from the selection
                        const jpgFiles = selected.filter(file => file.type === 'image/jpeg' || file.type === 'image/jpg');
                        if (jpgFiles.length > 0) {
                            window.originalJpgsForPdf = jpgFiles.map(file => ({ file, url: URL.createObjectURL(file) }));
                            setupJpgToPdfUI(window.originalJpgsForPdf);
                        } else {
                            alert("No valid JPG files selected for JPG to PDF conversion.");
                            resetToolState(toolId); // Reset if no valid files
                        }
                    }
                } else {
                    const file = selected;
                    let objectUrl;
                    try {
                        objectUrl = URL.createObjectURL(file);
                    } catch (e) {
                        alert(`Error creating URL for file ${file.name}. It might be too large or corrupted.`);
                        resetToolState(toolId);
                        return;
                    }

                    if (toolId === 'pdf-to-jpg') {
                        if (file.type === "application/pdf") {
                            window.originalPdfForJpg = { file, url: objectUrl };
                            setupPdfToJpgUI(file, objectUrl);
                        } else {
                             alert("Please select a valid PDF file for PDF to JPG conversion.");
                             if(objectUrl) URL.revokeObjectURL(objectUrl);
                             resetToolState(toolId);
                        }
                    } else { // Existing image tools
                        if (file.type.startsWith('image/')) {
                            handleImageFile(file, toolId, objectUrl); // Pass objectUrl to avoid re-creating
                        } else {
                            alert(`Please select a valid image file for ${toolId}.`);
                            if(objectUrl) URL.revokeObjectURL(objectUrl);
                            resetToolState(toolId);
                        }
                    }
                }
            }

            function handleImageFile(file, toolId, objectUrl) { // objectUrl is now passed in
                console.log(`[HANDLE_FILE] handleImageFile called for tool: ${toolId}, file: ${file.name}`);
                // resetToolState(toolId); // Already called in handleFileSelection

                let originalImageObj;
                let originalFileVarName;
                let toolSpecificLoadHandler;

                switch (toolId) {
                    case 'image-compressor': originalImageObj = originalCompressImage; originalFileVarName = 'originalCompressFile'; toolSpecificLoadHandler = setupCompressUI; break;
                    case 'image-resizer': originalImageObj = originalResizeImage; originalFileVarName = 'originalResizeFile'; toolSpecificLoadHandler = setupResizeUI; break;
                    case 'image-converter': originalImageObj = originalConvertImage; originalFileVarName = 'originalConvertFile'; toolSpecificLoadHandler = setupConvertUI; break;
                    case 'image-cropper': originalImageObj = originalCropImage; originalFileVarName = 'originalCropFile'; toolSpecificLoadHandler = setupCropUI; break;
                    case 'image-rotate-flip': originalImageObj = originalRotateFlipImage; originalFileVarName = 'originalRotateFlipFile'; toolSpecificLoadHandler = setupRotateFlipUI; break;
                    case 'image-filters': originalImageObj = originalFilterImage; originalFileVarName = 'originalFilterFile'; toolSpecificLoadHandler = setupFilterUI; break;
                    default: URL.revokeObjectURL(objectUrl); alert("Internal error: Unknown tool."); return;
                }
                window[originalFileVarName] = file;

                originalImageObj.onload = () => {
                    if (originalImageObj.naturalWidth > 0 && originalImageObj.naturalHeight > 0) {
                        toolSpecificLoadHandler(file, originalImageObj.src);
                    } else {
                        alert(`Could not load image data from ${file.name}. It might be corrupted or have zero dimensions.`);
                        URL.revokeObjectURL(originalImageObj.src); // Revoke the blob URL used by the Image object
                        resetToolState(toolId);
                    }
                    originalImageObj.onerror = null;
                };
                originalImageObj.onerror = (e) => {
                    alert(`Error loading image file ${file.name}. It might be corrupted or unsupported.`);
                    URL.revokeObjectURL(objectUrl); // Revoke the initial blob URL
                    resetToolState(toolId);
                    originalImageObj.onload = null;
                };
                originalImageObj.src = objectUrl;
            }


            // --- UI Setup and Listener Functions for Original Image Tools ---
            function setupCompressUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('compressImageInfo');
                 const originalFileNameSpan = document.getElementById('compressOriginalFileName');
                 const originalSizeSpan = document.getElementById('compressOriginalSize');
                 const compressedSizeSpan = document.getElementById('compressedSize');
                 const sizeReductionSpan = document.getElementById('sizeReduction');
                 const previewSection = document.getElementById('compressImagePreview');
                 const originalImagePreview = document.getElementById('originalImagePreview');
                 const compressedImagePreview = document.getElementById('compressedImagePreview');
                 const compressNowBtn = document.getElementById('compressNowBtn');
                 const qualitySlider = document.getElementById('compressionQuality');
                 const qualityValueSpan = document.getElementById('qualityValue');

                 originalFileNameSpan.textContent = file.name;
                 originalSizeSpan.textContent = formatBytes(file.size);
                 compressedSizeSpan.textContent = '-'; sizeReductionSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 originalImagePreview.src = originalCompressImage.src;
                 originalImagePreview.alt = `Original Image (${file.name})`;
                 originalImagePreview.style.display = 'block';
                 if (compressedImagePreview.src && compressedImagePreview.src.startsWith('blob:')) { try { URL.revokeObjectURL(compressedImagePreview.src); } catch (e) {} }
                 compressedImagePreview.src = ''; compressedImagePreview.alt = ''; compressedImagePreview.style.display = 'none';
                 previewSection.style.display = 'block';
                 compressNowBtn.disabled = false;
                 qualityValueSpan.textContent = qualitySlider.value + '%';
             }
            function setupImageCompressorListeners() {
                 const qualitySlider = document.getElementById('compressionQuality');
                 const qualityValueSpan = document.getElementById('qualityValue');
                 const compressNowBtn = document.getElementById('compressNowBtn');
                 const compressedSizeSpan = document.getElementById('compressedSize');
                 const sizeReductionSpan = document.getElementById('sizeReduction');
                 const originalImagePreview = document.getElementById('originalImagePreview');
                 const compressedImagePreview = document.getElementById('compressedImagePreview');
                 const downloadLink = document.getElementById('compressDownloadLink');
                 const downloadMessage = document.getElementById('compressDownloadMessage');
                 const processingMsg = document.getElementById('compressProcessingMsg');

                 qualitySlider.addEventListener('input', (event) => { qualityValueSpan.textContent = event.target.value + '%'; });
                 compressNowBtn.addEventListener('click', () => {
                     if (window.originalCompressFile && originalCompressImage && originalCompressImage.complete && originalCompressImage.naturalWidth > 0) {
                         processCompressImage(window.originalCompressFile, originalCompressImage, qualitySlider.value);
                     } else { alert("Please select an image file first."); }
                 });
                 addDropZoneListeners('image-compressor', 'compressDropZone', 'compressImageFile');

                 function processCompressImage(file, imageObj, quality) {
                     compressNowBtn.disabled = true; processingMsg.style.display = 'block';
                     if (compressedImagePreview.src && compressedImagePreview.src.startsWith('blob:')) { try { URL.revokeObjectURL(compressedImagePreview.src); } catch (e) {} }
                     compressedImagePreview.src = ''; compressedImagePreview.style.display = 'none';
                     if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                     downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';

                     const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                     canvas.width = imageObj.naturalWidth; canvas.height = imageObj.naturalHeight;
                     const mimeType = file.type === 'image/png' ? 'image/png' : file.type === 'image/webp' ? 'image/webp' : 'image/jpeg';
                     if (mimeType !== 'image/png' && mimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                     else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
                     ctx.drawImage(imageObj, 0, 0);
                     const outputQuality = quality / 100;
                     canvas.toBlob((blob) => {
                         if (blob) { updateCompressOutput(blob, file.name, file.size, mimeType); }
                         else { alert("Image compression failed."); compressedSizeSpan.textContent = 'Failed'; }
                         compressNowBtn.disabled = !(window.originalCompressFile && originalCompressImage.complete);
                         processingMsg.style.display = 'none';
                     }, mimeType, outputQuality);
                 }
                 function updateCompressOutput(compressedBlob, originalName, originalSize, mimeType) {
                    if (compressedImagePreview.src && compressedImagePreview.src.startsWith('blob:')) { try { URL.revokeObjectURL(compressedImagePreview.src); } catch (e) {} }
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    const compressedSize = compressedBlob.size; const objectUrl = URL.createObjectURL(compressedBlob);
                    compressedSizeSpan.textContent = formatBytes(compressedSize);
                    sizeReductionSpan.textContent = originalSize > 0 ? `${(((originalSize - compressedSize) / originalSize) * 100).toFixed(2)}%` : 'N/A';
                    compressedImagePreview.src = objectUrl; compressedImagePreview.alt = `Compressed Image`; compressedImagePreview.style.display = 'block';
                    if (originalImagePreview) originalImagePreview.style.display = 'block';
                    downloadLink.href = objectUrl;
                    downloadLink.download = `compressed_${originalName.replace(/\.[^/.]+$/, "")}.${mimeType.split('/')[1] === 'jpeg' ? 'jpg' : mimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
            }

            function setupResizeUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('resizeImageInfo');
                 const originalFileNameSpan = document.getElementById('resizeOriginalFileName');
                 const originalDimensionsSpan = document.getElementById('originalDimensions');
                 const newDimensionsSpan = document.getElementById('newDimensions');
                 const originalSizeSpan = document.getElementById('resizeOriginalSize');
                 const resizedSizeSpan = document.getElementById('resizedSize');
                 const previewSectionEl = document.getElementById('resizeImagePreview');
                 const resizedImage = document.getElementById('resizedImage');
                 const widthInput = document.getElementById('resizeWidth');
                 const heightInput = document.getElementById('resizeHeight');
                 const applyBtn = document.getElementById('applyResizeBtn');

                 const originalResizeWidth = originalResizeImage.naturalWidth; const originalResizeHeight = originalResizeImage.naturalHeight;
                 originalFileNameSpan.textContent = file.name;
                 originalDimensionsSpan.textContent = `${originalResizeWidth}x${originalResizeHeight}`;
                 originalSizeSpan.textContent = formatBytes(file.size);
                 newDimensionsSpan.textContent = '-'; resizedSizeSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 if (resizedImage.src && resizedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(resizedImage.src); } catch (e) {} }
                 resizedImage.src = originalResizeImage.src;
                 resizedImage.alt = `Original Image Preview (${file.name})`;
                 resizedImage.style.display = 'block';
                 if(previewSectionEl) previewSectionEl.style.display = 'block';
                 widthInput.value = originalResizeWidth; heightInput.value = originalResizeHeight;
                 applyBtn.disabled = false;
            }
            function setupImageResizerListeners() {
                 const widthInput = document.getElementById('resizeWidth');
                 const heightInput = document.getElementById('resizeHeight');
                 const applyBtn = document.getElementById('applyResizeBtn');
                 const newDimensionsSpan = document.getElementById('newDimensions');
                 const resizedSizeSpan = document.getElementById('resizedSize');
                 const resizedImage = document.getElementById('resizedImage');
                 const downloadLink = document.getElementById('resizeDownloadLink');
                 const downloadMessage = document.getElementById('resizeDownloadMessage');
                 const processingMsg = document.getElementById('resizeProcessingMsg');

                 const dimensionInputHandler = () => {
                    const isImageReady = originalResizeImage && originalResizeImage.complete;
                    if (!isImageReady) { applyBtn.disabled = true; return; }
                    const w = parseInt(widthInput.value); const h = parseInt(heightInput.value);
                    applyBtn.disabled = !(!isNaN(w) && w > 0 && !isNaN(h) && h > 0);
                 };
                 widthInput.addEventListener('input', dimensionInputHandler);
                 heightInput.addEventListener('input', dimensionInputHandler);
                 applyBtn.addEventListener('click', () => {
                    const newWidth = parseInt(widthInput.value); const newHeight = parseInt(heightInput.value);
                    if (window.originalResizeFile && originalResizeImage.complete && !isNaN(newWidth) && newWidth > 0 && !isNaN(newHeight) && newHeight > 0) {
                        performResize(window.originalResizeFile, originalResizeImage, newWidth, newHeight);
                    } else { alert("Please select a file and enter valid dimensions."); }
                 });
                 addDropZoneListeners('image-resizer', 'resizeDropZone', 'resizeImageFile');

                 function performResize(file, imageObj, newWidth, newHeight) {
                     applyBtn.disabled = true; processingMsg.style.display = 'block';
                     if (resizedImage.src && resizedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(resizedImage.src); } catch (e) {} }
                     resizedImage.src = ''; resizedImage.style.display = 'none';
                     if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                     downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                     newDimensionsSpan.textContent = '-'; resizedSizeSpan.textContent = '-';

                     const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                     canvas.width = newWidth; canvas.height = newHeight;
                     const mimeType = file.type.startsWith('image/') ? file.type : 'image/jpeg';
                     if (mimeType !== 'image/png' && mimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                     else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
                     ctx.drawImage(imageObj, 0, 0, newWidth, newHeight);
                     canvas.toBlob((blob) => {
                         if (blob) { updateResizeOutput(blob, file.name, newWidth, newHeight, mimeType); }
                         else { alert("Image resizing failed."); newDimensionsSpan.textContent = 'Failed'; }
                         const w = parseInt(widthInput?.value); const h = parseInt(heightInput?.value);
                         applyBtn.disabled = !(window.originalResizeFile && originalResizeImage.complete && !isNaN(w) && w > 0 && !isNaN(h) && h > 0);
                         processingMsg.style.display = 'none';
                     }, mimeType);
                 }
                 function updateResizeOutput(resizedBlob, originalName, newWidth, newHeight, mimeType) {
                    if (resizedImage.src && resizedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(resizedImage.src); } catch (e) {} }
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    const objectUrl = URL.createObjectURL(resizedBlob);
                    newDimensionsSpan.textContent = `${newWidth}x${newHeight}`;
                    resizedSizeSpan.textContent = formatBytes(resizedBlob.size);
                    resizedImage.src = objectUrl; resizedImage.style.display = 'block'; resizedImage.alt = `Resized Image`;
                    document.getElementById('resizeImagePreview').style.display = 'block';
                    downloadLink.href = objectUrl;
                    downloadLink.download = `resized_${originalName.replace(/\.[^/.]+$/, "")}.${mimeType.split('/')[1] === 'jpeg' ? 'jpg' : mimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
            }

            function setupConvertUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('convertImageInfo');
                 const originalFileNameSpan = document.getElementById('convertOriginalFileName');
                 const originalFormatSpan = document.getElementById('originalFormat');
                 const newFormatSpan = document.getElementById('newFormat');
                 const originalSizeSpan = document.getElementById('convertOriginalSize');
                 const convertedSizeSpan = document.getElementById('convertedSize');
                 const previewSectionEl = document.getElementById('convertImagePreview');
                 const convertedImage = document.getElementById('convertedImage');
                 const formatSelect = document.getElementById('outputFormat');
                 const applyBtn = document.getElementById('applyConvertBtn');

                 originalFileNameSpan.textContent = file.name;
                 originalFormatSpan.textContent = file.type.split('/')[1]?.toUpperCase() || 'Unknown';
                 originalSizeSpan.textContent = formatBytes(file.size);
                 newFormatSpan.textContent = '-'; convertedSizeSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 if (convertedImage.src && convertedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(convertedImage.src); } catch (e) {} }
                 convertedImage.src = originalConvertImage.src;
                 convertedImage.alt = `Original Image Preview (${file.name})`;
                 convertedImage.style.display = 'block';
                 if(previewSectionEl) previewSectionEl.style.display = 'block';
                 formatSelect.value = 'image/jpeg';
                 applyBtn.disabled = false;
            }
            function setupImageConverterListeners() {
                 const formatSelect = document.getElementById('outputFormat');
                 const applyBtn = document.getElementById('applyConvertBtn');
                 const originalFormatSpan = document.getElementById('originalFormat');
                 const newFormatSpan = document.getElementById('newFormat');
                 const convertedSizeSpan = document.getElementById('convertedSize');
                 const convertedImage = document.getElementById('convertedImage');
                 const downloadLink = document.getElementById('convertDownloadLink');
                 const downloadMessage = document.getElementById('convertDownloadMessage');
                 const processingMsg = document.getElementById('convertProcessingMsg');

                 formatSelect.addEventListener('change', () => {
                    applyBtn.disabled = !(window.originalConvertFile && originalConvertImage.complete);
                 });
                 applyBtn.addEventListener('click', () => {
                    const outputMimeType = formatSelect.value;
                    if (window.originalConvertFile && originalConvertImage.complete && outputMimeType) {
                        performConversion(window.originalConvertFile, originalConvertImage, outputMimeType);
                    } else { alert("Please select a file and an output format."); }
                 });
                 addDropZoneListeners('image-converter', 'convertDropZone', 'convertImageFile');

                 function performConversion(file, imageObj, outputMimeType) {
                     applyBtn.disabled = true; processingMsg.style.display = 'block';
                     if (convertedImage.src && convertedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(convertedImage.src); } catch (e) {} }
                     convertedImage.src = ''; convertedImage.style.display = 'none';
                     if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                     downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                     newFormatSpan.textContent = '-'; convertedSizeSpan.textContent = '-';

                     const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                     canvas.width = imageObj.naturalWidth; canvas.height = imageObj.naturalHeight;
                     if (outputMimeType !== 'image/png' && outputMimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                     else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
                     ctx.drawImage(imageObj, 0, 0);
                     canvas.toBlob((blob) => {
                         if (blob) { updateConvertOutput(blob, file.name, outputMimeType, file.type); }
                         else { alert("Image conversion failed."); newFormatSpan.textContent = 'Failed'; }
                         applyBtn.disabled = !(window.originalConvertFile && originalConvertImage.complete && formatSelect.value);
                         processingMsg.style.display = 'none';
                     }, outputMimeType, 0.8);
                 }
                 function updateConvertOutput(convertedBlob, originalName, outputMimeType, originalMimeType) {
                    if (convertedImage.src && convertedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(convertedImage.src); } catch (e) {} }
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    const objectUrl = URL.createObjectURL(convertedBlob);
                    originalFormatSpan.textContent = originalMimeType.split('/')[1]?.toUpperCase() || 'Unknown';
                    newFormatSpan.textContent = outputMimeType.split('/')[1]?.toUpperCase() || 'Unknown';
                    convertedSizeSpan.textContent = formatBytes(convertedBlob.size);
                    convertedImage.src = objectUrl; convertedImage.style.display = 'block'; convertedImage.alt = `Converted Image`;
                    document.getElementById('convertImagePreview').style.display = 'block';
                    downloadLink.href = objectUrl;
                    downloadLink.download = `converted_${originalName.replace(/\.[^/.]+$/, "")}.${outputMimeType.split('/')[1] === 'jpeg' ? 'jpg' : outputMimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
            }

            function setupCropUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('cropImageInfo');
                 const originalFileNameSpan = document.getElementById('cropOriginalFileName');
                 const originalDimensionsSpan = document.getElementById('cropOriginalDimensions');
                 const originalSizeSpan = document.getElementById('cropOriginalSize');
                 const newCropDimensionsSpan = document.getElementById('newCropDimensions');
                 const croppedSizeSpan = document.getElementById('croppedSize');
                 const previewSection = document.getElementById('cropImagePreview');
                 const cropperContainer = previewSection?.querySelector('.cropper-container');
                 const cropOriginalImagePreview = document.getElementById('cropOriginalImagePreview');
                 const cropSelectionOverlay = previewSection?.querySelector('.crop-selection-overlay');
                 const croppedImage = document.getElementById('croppedImage');
                 const selectAreaBtn = document.getElementById('selectCropAreaBtn');
                 const cropAndDownloadBtn = document.getElementById('cropAndDownloadBtn');

                 const originalCropWidth = originalCropImage.naturalWidth; const originalCropHeight = originalCropImage.naturalHeight;
                 originalFileNameSpan.textContent = file.name;
                 originalDimensionsSpan.textContent = `${originalCropWidth}x${originalCropHeight}`;
                 originalSizeSpan.textContent = formatBytes(file.size);
                 newCropDimensionsSpan.textContent = '-'; croppedSizeSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 cropOriginalImagePreview.src = originalCropImage.src;
                 cropOriginalImagePreview.alt = `Image to Crop (${file.name})`;
                 cropOriginalImagePreview.style.display = 'block';
                 if (croppedImage.src && croppedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(croppedImage.src); } catch (e) {} }
                 croppedImage.src = ''; croppedImage.alt = ''; croppedImage.style.display = 'none';
                 previewSection.style.display = 'block';
                 selectAreaBtn.disabled = false; cropAndDownloadBtn.disabled = true;
                 cropperContainer.style.cursor = 'default';
                 cropSelectionOverlay.style.cssText = 'display: none; top: 0; left: 0; width: 0; height: 0;';
            }
            function setupImageCropperListeners() {
                 const selectAreaBtn = document.getElementById('selectCropAreaBtn');
                 const cropAndDownloadBtn = document.getElementById('cropAndDownloadBtn');
                 const newCropDimensionsSpan = document.getElementById('newCropDimensions');
                 const croppedSizeSpan = document.getElementById('croppedSize');
                 const previewSection = document.getElementById('cropImagePreview');
                 const cropperContainer = previewSection?.querySelector('.cropper-container');
                 const cropOriginalImagePreview = document.getElementById('cropOriginalImagePreview');
                 const cropSelectionOverlay = previewSection?.querySelector('.crop-selection-overlay');
                 const croppedImage = document.getElementById('croppedImage');
                 const downloadLink = document.getElementById('cropDownloadLink');
                 const downloadMessage = document.getElementById('cropDownloadMessage');
                 const processingMsg = document.getElementById('cropProcessingMsg');

                let isSelectingCropArea = false; let isDragging = false; let startX = 0, startY = 0;

                 selectAreaBtn.addEventListener('click', () => {
                    if (window.originalCropFile && originalCropImage.complete) {
                        isSelectingCropArea = true; isDragging = false;
                        cropSelectionOverlay.style.cssText = 'display: none; top: 0; left: 0; width: 0; height: 0;';
                        cropOriginalImagePreview.style.display = 'block';
                        if (croppedImage.src && croppedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(croppedImage.src); } catch (e) {} }
                        croppedImage.src = ''; croppedImage.style.display = 'none';
                        newCropDimensionsSpan.textContent = '-'; croppedSizeSpan.textContent = '-';
                        if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                        downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                        window.finalScaledCrop = null; cropAndDownloadBtn.disabled = true;
                        cropperContainer.style.cursor = 'crosshair'; selectAreaBtn.disabled = true;
                    } else { alert("Please select an image file first."); }
                 });

                 cropperContainer.addEventListener('mousedown', (e) => {
                    if (!isSelectingCropArea || isDragging || e.button !== 0) return; e.preventDefault();
                    isDragging = true;
                    const containerRect = cropperContainer.getBoundingClientRect();
                    startX = Math.max(0, Math.min(e.clientX - containerRect.left, containerRect.width));
                    startY = Math.max(0, Math.min(e.clientY - containerRect.top, containerRect.height));
                    cropSelectionOverlay.style.left = `${startX}px`; cropSelectionOverlay.style.top = `${startY}px`;
                    cropSelectionOverlay.style.width = '0'; cropSelectionOverlay.style.height = '0';
                    cropSelectionOverlay.style.display = 'block';
                    newCropDimensionsSpan.textContent = '-'; croppedSizeSpan.textContent = '-';
                    cropAndDownloadBtn.disabled = true; window.finalScaledCrop = null;
                 });

                 cropperContainer.addEventListener('mousemove', (e) => {
                    if (!isDragging) return; e.preventDefault();
                    const containerRect = cropperContainer.getBoundingClientRect();
                    const cx = Math.max(0, Math.min(e.clientX - containerRect.left, containerRect.width));
                    const cy = Math.max(0, Math.min(e.clientY - containerRect.top, containerRect.height));
                    const x = Math.min(cx, startX); const y = Math.min(cy, startY);
                    const w = Math.abs(cx - startX); const h = Math.abs(cy - startY);
                    cropSelectionOverlay.style.left = `${x}px`; cropSelectionOverlay.style.top = `${y}px`;
                    cropSelectionOverlay.style.width = `${w}px`; cropSelectionOverlay.style.height = `${h}px`;
                    cropAndDownloadBtn.disabled = !(w > 0 && h > 0);
                 });

                 document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return; isDragging = false;
                    if (!isSelectingCropArea) return;

                    const fw = cropSelectionOverlay.offsetWidth || 0; const fh = cropSelectionOverlay.offsetHeight || 0;
                    if (fw > 0 && fh > 0 && cropOriginalImagePreview && originalCropImage.naturalWidth > 0) {
                        const overlayRect = cropSelectionOverlay.getBoundingClientRect();
                        const imgRect = cropOriginalImagePreview.getBoundingClientRect();
                        const scaleX = originalCropImage.naturalWidth / imgRect.width;
                        const scaleY = originalCropImage.naturalHeight / imgRect.height;
                        const finalX = Math.round(Math.max(0, overlayRect.left - imgRect.left) * scaleX);
                        const finalY = Math.round(Math.max(0, overlayRect.top - imgRect.top) * scaleY);
                        const finalWidth = Math.round(Math.min(fw, imgRect.width - (overlayRect.left - imgRect.left)) * scaleX);
                        const finalHeight = Math.round(Math.min(fh, imgRect.height - (overlayRect.top - imgRect.top)) * scaleY);

                        if (finalWidth > 0 && finalHeight > 0) {
                            window.finalScaledCrop = { x: finalX, y: finalY, width: finalWidth, height: finalHeight };
                            newCropDimensionsSpan.textContent = `${window.finalScaledCrop.width}x${window.finalScaledCrop.height}`;
                            cropAndDownloadBtn.disabled = false; isSelectingCropArea = false;
                            cropperContainer.style.cursor = 'default';
                        } else {
                            window.finalScaledCrop = null; cropSelectionOverlay.style.display = 'none'; cropAndDownloadBtn.disabled = true;
                            isSelectingCropArea = false; cropperContainer.style.cursor = 'default';
                            selectAreaBtn.disabled = !(window.originalCropFile && originalCropImage.complete);
                        }
                    } else {
                        window.finalScaledCrop = null; cropSelectionOverlay.style.display = 'none'; cropAndDownloadBtn.disabled = true;
                        isSelectingCropArea = false; cropperContainer.style.cursor = 'default';
                        selectAreaBtn.disabled = !(window.originalCropFile && originalCropImage.complete);
                    }
                 });

                 cropAndDownloadBtn.addEventListener('click', () => {
                    if (window.originalCropFile && originalCropImage.complete && window.finalScaledCrop) {
                        performCrop(window.originalCropFile, originalCropImage);
                    } else { alert("Please select an image and define a crop area first."); }
                 });
                 addDropZoneListeners('image-cropper', 'cropDropZone', 'cropImageFile');

                 function performCrop(file, imageObj) {
                     const { x, y, width, height } = window.finalScaledCrop;
                     cropAndDownloadBtn.disabled = true; selectAreaBtn.disabled = true; processingMsg.style.display = 'block';
                     if (croppedImage.src && croppedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(croppedImage.src); } catch (e) {} }
                     croppedImage.src = ''; croppedImage.style.display = 'none';
                     cropOriginalImagePreview.style.display = 'none';
                     if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                     downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                     newCropDimensionsSpan.textContent = '-'; croppedSizeSpan.textContent = '-';

                     const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                     canvas.width = width; canvas.height = height;
                     const mimeType = file.type.startsWith('image/') ? file.type : 'image/jpeg';
                     if (mimeType !== 'image/png' && mimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                     else { ctx.clearRect(0, 0, canvas.width, canvas.height); }
                     ctx.drawImage(imageObj, x, y, width, height, 0, 0, width, height);
                     canvas.toBlob((blob) => {
                         if (blob) { updateCropOutput(blob, file.name, width, height, mimeType); }
                         else { alert("Image cropping failed."); newCropDimensionsSpan.textContent = 'Failed';}
                         selectAreaBtn.disabled = !(window.originalCropFile && originalCropImage.complete);
                         cropAndDownloadBtn.disabled = true; processingMsg.style.display = 'none';
                     }, mimeType);
                 }
                 function updateCropOutput(croppedBlob, originalName, newWidth, newHeight, mimeType) {
                    if (croppedImage.src && croppedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(croppedImage.src); } catch (e) {} }
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    const objectUrl = URL.createObjectURL(croppedBlob);
                    newCropDimensionsSpan.textContent = `${newWidth}x${newHeight}`;
                    croppedSizeSpan.textContent = formatBytes(croppedBlob.size);
                    croppedImage.src = objectUrl; croppedImage.style.display = 'block'; croppedImage.alt = `Cropped Image`;
                    previewSection.style.display = 'block'; cropOriginalImagePreview.style.display = 'none'; cropSelectionOverlay.style.display = 'none';
                    window.finalScaledCrop = null; cropperContainer.style.cursor = 'default';
                    downloadLink.href = objectUrl;
                    downloadLink.download = `cropped_${originalName.replace(/\.[^/.]+$/, "")}.${mimeType.split('/')[1] === 'jpeg' ? 'jpg' : mimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
            }

            function setupRotateFlipUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('rotateFlipImageInfo');
                 const originalFileNameSpan = document.getElementById('rotateFlipOriginalFileName');
                 const originalDimensionsSpan = document.getElementById('originalRotateFlipDimensions');
                 const originalSizeSpan = document.getElementById('rotateFlipOriginalSize');
                 const newRotateFlipDimensionsSpan = document.getElementById('newRotateFlipDimensions');
                 const newRotateFlipSizeSpan = document.getElementById('newRotateFlipSize');
                 const previewSection = document.getElementById('rotateFlipImagePreview');
                 const rotatedFlippedImage = document.getElementById('rotatedFlippedImage');
                 const rotateLeftBtn = document.getElementById('rotateLeftBtn'); /* and others */

                 originalFileNameSpan.textContent = file.name;
                 originalDimensionsSpan.textContent = `${originalRotateFlipImage.naturalWidth}x${originalRotateFlipImage.naturalHeight}`;
                 originalSizeSpan.textContent = formatBytes(file.size);
                 newRotateFlipDimensionsSpan.textContent = '-'; newRotateFlipSizeSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 if (currentRotateFlipImage.src && currentRotateFlipImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(currentRotateFlipImage.src); } catch (e) {} }
                 currentRotateFlipImage.src = originalRotateFlipImage.src;
                 if (rotatedFlippedImage.src && rotatedFlippedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(rotatedFlippedImage.src); } catch (e) {} }
                 rotatedFlippedImage.src = currentRotateFlipImage.src;
                 rotatedFlippedImage.alt = `Original Image (${file.name})`;
                 rotatedFlippedImage.style.display = 'block';
                 previewSection.style.display = 'block';
                 document.querySelectorAll('#image-rotate-flip-section .rotate-flip-controls button').forEach(btn => btn.disabled = false);
            }
            function setupImageRotateFlipListeners() {
                 const rotateLeftBtn = document.getElementById('rotateLeftBtn');
                 const rotateRightBtn = document.getElementById('rotateRightBtn');
                 const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
                 const flipVerticalBtn = document.getElementById('flipVerticalBtn');
                 const newRotateFlipDimensionsSpan = document.getElementById('newRotateFlipDimensions');
                 const newRotateFlipSizeSpan = document.getElementById('newRotateFlipSize');
                 const rotatedFlippedImage = document.getElementById('rotatedFlippedImage');
                 const downloadLink = document.getElementById('rotateFlipDownloadLink');
                 const downloadMessage = document.getElementById('rotateFlipDownloadMessage');
                 const processingMsg = document.getElementById('rotateFlipProcessingMsg');
                 const controlButtons = [rotateLeftBtn, rotateRightBtn, flipHorizontalBtn, flipVerticalBtn];

                 function performTransform(transformType) {
                    if (!window.originalRotateFlipFile || !currentRotateFlipImage.complete) {
                        alert("Please select an image first."); return;
                    }
                    controlButtons.forEach(btn => btn.disabled = true); processingMsg.style.display = 'block';
                    if (rotatedFlippedImage.src && rotatedFlippedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(rotatedFlippedImage.src); } catch (e) {} }
                    rotatedFlippedImage.src = ''; rotatedFlippedImage.style.display = 'none';
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                    newRotateFlipDimensionsSpan.textContent = '-'; newRotateFlipSizeSpan.textContent = '-';

                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    let iw = currentRotateFlipImage.naturalWidth, ih = currentRotateFlipImage.naturalHeight;
                    if (transformType === 'rotateLeft' || transformType === 'rotateRight') { canvas.width = ih; canvas.height = iw; }
                    else { canvas.width = iw; canvas.height = ih; }
                    const mimeType = window.originalRotateFlipFile.type.startsWith('image/') ? window.originalRotateFlipFile.type : 'image/jpeg';
                    if (mimeType !== 'image/png' && mimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                    else { ctx.clearRect(0, 0, canvas.width, canvas.height); }

                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    if (transformType === 'rotateRight') ctx.rotate(90 * Math.PI / 180);
                    else if (transformType === 'rotateLeft') ctx.rotate(-90 * Math.PI / 180);
                    else if (transformType === 'flipHorizontal') ctx.scale(-1, 1);
                    else if (transformType === 'flipVertical') ctx.scale(1, -1);
                    ctx.drawImage(currentRotateFlipImage, -iw / 2, -ih / 2);
                    ctx.setTransform(1, 0, 0, 1, 0, 0);

                    canvas.toBlob((blob) => {
                        if (blob) {
                            const newUrl = URL.createObjectURL(blob);
                            const previousCurrentUrl = currentRotateFlipImage.src;
                            currentRotateFlipImage.onload = () => {
                                updateRotateFlipOutput(blob, newUrl, window.originalRotateFlipFile.name, currentRotateFlipImage.naturalWidth, currentRotateFlipImage.naturalHeight, mimeType);
                                controlButtons.forEach(btn => btn.disabled = false);
                                if (previousCurrentUrl && previousCurrentUrl.startsWith('blob:')) { try { URL.revokeObjectURL(previousCurrentUrl); } catch (e) {} }
                            };
                            currentRotateFlipImage.onerror = () => {
                                alert("Error displaying transformed image."); controlButtons.forEach(btn => btn.disabled = false);
                                if (newUrl && newUrl.startsWith('blob:')) { try { URL.revokeObjectURL(newUrl); } catch (e) {} }
                            };
                            currentRotateFlipImage.src = newUrl;
                        } else {
                             alert("Image transformation failed."); controlButtons.forEach(btn => btn.disabled = false);
                        }
                        processingMsg.style.display = 'none';
                    }, mimeType);
                 }
                 function updateRotateFlipOutput(resultBlob, objectUrl, originalName, newWidth, newHeight, mimeType) {
                    if (rotatedFlippedImage.src && rotatedFlippedImage.src.startsWith('blob:')) { try { URL.revokeObjectURL(rotatedFlippedImage.src); } catch (e) {} }
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch (e) {} }
                    newRotateFlipSizeSpan.textContent = formatBytes(resultBlob.size);
                    newRotateFlipDimensionsSpan.textContent = `${newWidth}x${newHeight}`;
                    rotatedFlippedImage.src = currentRotateFlipImage.src; // current image holds the latest transform
                    rotatedFlippedImage.style.display = 'block'; rotatedFlippedImage.alt = `Transformed Image`;
                    document.getElementById('rotateFlipImagePreview').style.display = 'block';
                    downloadLink.href = currentRotateFlipImage.src; // Download the latest transform
                    downloadLink.download = `transformed_${originalName.replace(/\.[^/.]+$/, "")}.${mimeType.split('/')[1] === 'jpeg' ? 'jpg' : mimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
                 rotateLeftBtn.addEventListener('click', () => performTransform('rotateLeft'));
                 rotateRightBtn.addEventListener('click', () => performTransform('rotateRight'));
                 flipHorizontalBtn.addEventListener('click', () => performTransform('flipHorizontal'));
                 flipVerticalBtn.addEventListener('click', () => performTransform('flipVertical'));
                 addDropZoneListeners('image-rotate-flip', 'rotateFlipDropZone', 'rotateFlipImageFile');
            }

            function setupFilterUI(file, imgUrl) {
                 const imageInfoDiv = document.getElementById('filterImageInfo');
                 const originalFileNameSpan = document.getElementById('filterOriginalFileName');
                 const originalDimensionsSpan = document.getElementById('originalFilterDimensions');
                 const originalSizeSpan = document.getElementById('filterOriginalSize');
                 const newFilterSizeSpan = document.getElementById('newFilterSize');
                 const previewSection = document.getElementById('filterImagePreview');
                 const filteredImage = document.getElementById('filteredImage');
                 const filterTypeSelect = document.getElementById('filterType');
                 const applyFilterBtn = document.getElementById('applyFilterBtn');

                 originalFileNameSpan.textContent = file.name;
                 originalDimensionsSpan.textContent = `${originalFilterImage.naturalWidth}x${originalFilterImage.naturalHeight}`;
                 originalSizeSpan.textContent = formatBytes(file.size);
                 newFilterSizeSpan.textContent = '-';
                 imageInfoDiv.style.display = 'block';
                 filteredImage.src = originalFilterImage.src; // Show original on load
                 filteredImage.alt = `Original Image (${file.name})`;
                 filteredImage.style.display = 'block';
                 previewSection.style.display = 'block';
                 filterTypeSelect.disabled = false; filterTypeSelect.value = 'none';
                 applyFilterBtn.disabled = true; // Disabled as 'none' is selected
            }
            function setupImageFiltersListeners() {
                 const filterTypeSelect = document.getElementById('filterType');
                 const applyFilterBtn = document.getElementById('applyFilterBtn');
                 const newFilterSizeSpan = document.getElementById('newFilterSize');
                 const filteredImage = document.getElementById('filteredImage');
                 const downloadLink = document.getElementById('filterDownloadLink');
                 const downloadMessage = document.getElementById('filterDownloadMessage');
                 const processingMsg = document.getElementById('filterProcessingMsg');

                 filterTypeSelect.addEventListener('change', () => {
                    const selectedFilter = filterTypeSelect.value;
                    const isImageReady = window.originalFilterFile && originalFilterImage.complete;
                    applyFilterBtn.disabled = !(isImageReady && selectedFilter !== 'none');
                    if (isImageReady && selectedFilter === 'none') applyFilter('none');
                    else if (isImageReady && selectedFilter !== 'none') {
                        // Clear previous non-original preview when a new filter is selected but not yet applied
                        if (filteredImage.src !== originalFilterImage.src && filteredImage.src.startsWith('blob:')) {
                            try { URL.revokeObjectURL(filteredImage.src); } catch(e){}
                        }
                        filteredImage.src = originalFilterImage.src; // Show original until applied
                        filteredImage.alt = `Original Image (${window.originalFilterFile.name})`;
                        if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch(e){} }
                        downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                        newFilterSizeSpan.textContent = '-';
                    }
                 });
                 applyFilterBtn.addEventListener('click', () => {
                    const selectedFilter = filterTypeSelect.value;
                    if (window.originalFilterFile && originalFilterImage.complete && selectedFilter && selectedFilter !== 'none') {
                        applyFilter(selectedFilter);
                    } else { alert("Please select an image and a filter other than 'None'."); }
                 });
                 addDropZoneListeners('image-filters', 'filterDropZone', 'filterImageFile');

                 function applyFilter(filterType) {
                    const file = window.originalFilterFile; const imageObj = originalFilterImage;
                    if (!file || !imageObj.complete) { alert("Please select an image."); return; }

                    const prevFilteredSrc = filteredImage.src;
                    if (prevFilteredSrc && prevFilteredSrc.startsWith('blob:') && prevFilteredSrc !== imageObj.src) { // Don't revoke original source
                        try { URL.revokeObjectURL(prevFilteredSrc); } catch (e) {}
                    }

                    if (filterType === 'none') {
                        filteredImage.src = imageObj.src; // originalFilterImage.src
                        filteredImage.alt = `Original Image (${file.name})`;
                        newFilterSizeSpan.textContent = formatBytes(file.size);
                        if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch(e){} }
                        downloadLink.style.display = 'none'; downloadMessage.style.display = 'none'; // No download for 'none' or original
                        applyFilterBtn.disabled = true; processingMsg.style.display = 'none';
                        return;
                    }

                    filterTypeSelect.disabled = true; applyFilterBtn.disabled = true; processingMsg.style.display = 'block';
                    filteredImage.style.display = 'none';
                    if (downloadLink.href && downloadLink.href.startsWith('blob:')) { try { URL.revokeObjectURL(downloadLink.href); } catch(e){} }
                    downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
                    newFilterSizeSpan.textContent = '-';

                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const width = imageObj.naturalWidth; const height = imageObj.naturalHeight;
                    canvas.width = width; canvas.height = height;
                    const mimeType = file.type.startsWith('image/') ? file.type : 'image/jpeg';
                    if (mimeType !== 'image/png' && mimeType !== 'image/webp') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, width, height); }
                    else { ctx.clearRect(0, 0, width, height); }
                    ctx.drawImage(imageObj, 0, 0, width, height);
                    let imageData = ctx.getImageData(0, 0, width, height); let pixels = imageData.data;
                    // Apply actual filter logic
                    switch(filterType) {
                       case 'grayscale': for (let i = 0; i < pixels.length; i += 4) { const avg = Math.round(0.2126 * pixels[i] + 0.7152 * pixels[i + 1] + 0.0722 * pixels[i + 2]); pixels[i] = avg; pixels[i + 1] = avg; pixels[i + 2] = avg; } break;
                       case 'sepia': for (let i = 0; i < pixels.length; i += 4) { const r = pixels[i], g = pixels[i + 1], b = pixels[i + 2]; pixels[i] = Math.min(255, Math.round(0.393 * r + 0.769 * g + 0.189 * b)); pixels[i + 1] = Math.min(255, Math.round(0.349 * r + 0.686 * g + 0.168 * b)); pixels[i + 2] = Math.min(255, Math.round(0.272 * r + 0.534 * g + 0.131 * b)); } break;
                       case 'invert': for (let i = 0; i < pixels.length; i += 4) { pixels[i] = 255 - pixels[i]; pixels[i + 1] = 255 - pixels[i + 1]; pixels[i + 2] = 255 - pixels[i + 2]; } break;
                       case 'red': for (let i = 0; i < pixels.length; i += 4) { pixels[i + 1] = 0; pixels[i + 2] = 0; } break;
                       case 'green': for (let i = 0; i < pixels.length; i += 4) { pixels[i] = 0; pixels[i + 2] = 0; } break;
                       case 'blue': for (let i = 0; i < pixels.length; i += 4) { pixels[i] = 0; pixels[i + 1] = 0; } break;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const newObjectUrl = URL.createObjectURL(blob);
                            updateFilterOutput(blob, newObjectUrl, file.name, mimeType);
                        } else { alert("Image filtering failed."); newFilterSizeSpan.textContent = 'Failed'; }
                        filterTypeSelect.disabled = false; applyFilterBtn.disabled = filterTypeSelect.value === 'none';
                        processingMsg.style.display = 'none';
                    }, mimeType, 0.85);
                 }
                 function updateFilterOutput(resultBlob, objectUrl, originalName, mimeType) {
                    newFilterSizeSpan.textContent = formatBytes(resultBlob.size);
                    filteredImage.src = objectUrl;
                    filteredImage.alt = `Filtered Image (${originalName})`;
                    filteredImage.style.display = 'block';
                    downloadLink.href = objectUrl;
                    downloadLink.download = `filtered_${originalName.replace(/\.[^/.]+$/, "")}.${mimeType.split('/')[1] === 'jpeg' ? 'jpg' : mimeType.split('/')[1]}`;
                    downloadLink.style.display = 'inline-block'; downloadMessage.style.display = 'block';
                 }
            }

            // --- JPG to PDF ---
            function setupJpgToPdfUI(fileObjects) {
                const fileListDisplay = document.getElementById('jpgToPdfFileList');
                const fileListUl = document.getElementById('jpgToPdfFilesListUl');
                const convertBtn = document.getElementById('convertToPdfBtn');
                const outputInfo = document.getElementById('jpgToPdfOutputInfo');
                const resultText = document.getElementById('jpgToPdfResultText');
                const downloadLink = document.getElementById('jpgToPdfDownloadLink');
                const downloadMessage = document.getElementById('jpgToPdfDownloadMessage');

                fileListUl.innerHTML = '';
                if (fileObjects.length > 0) {
                    fileObjects.forEach(fileObj => {
                        const li = document.createElement('li');
                        li.textContent = `${fileObj.file.name} (${formatBytes(fileObj.file.size)})`;
                        fileListUl.appendChild(li);
                    });
                    fileListDisplay.style.display = 'block';
                    convertBtn.disabled = false;
                } else {
                    fileListDisplay.style.display = 'none';
                    convertBtn.disabled = true;
                }
                outputInfo.style.display = 'none'; resultText.textContent = '';
                if(downloadLink.href && downloadLink.href.startsWith('blob:')) { try{URL.revokeObjectURL(downloadLink.href); }catch(e){}}
                downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
            }
            function setupJpgToPdfListeners() {
                addDropZoneListeners('jpg-to-pdf', 'jpgToPdfDropZone', 'jpgToPdfFilesInput', true, "image/jpeg");
                const convertBtn = document.getElementById('convertToPdfBtn');
                const processingMsg = document.getElementById('jpgToPdfProcessingMsg');
                const downloadLink = document.getElementById('jpgToPdfDownloadLink');
                const downloadMessage = document.getElementById('jpgToPdfDownloadMessage');
                const outputInfo = document.getElementById('jpgToPdfOutputInfo');
                const resultText = document.getElementById('jpgToPdfResultText');

                convertBtn.addEventListener('click', async () => {
                    if (window.originalJpgsForPdf.length === 0) { alert("Please select JPG files first."); return; }
                    convertBtn.disabled = true; processingMsg.style.display = 'block';
                    outputInfo.style.display = 'none';
                    if(downloadLink.href && downloadLink.href.startsWith('blob:')) { try{URL.revokeObjectURL(downloadLink.href); }catch(e){}}
                    downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ unit: 'pt', format: 'a4' }); // A4 is a good default

                    try {
                        for (let i = 0; i < window.originalJpgsForPdf.length; i++) {
                            const fileObj = window.originalJpgsForPdf[i];
                            processingMsg.textContent = `Processing image ${i + 1} of ${window.originalJpgsForPdf.length}...`;
                            const img = new Image();
                            img.src = fileObj.url;

                            await new Promise((resolve, reject) => {
                                img.onload = () => {
                                    const imgWidth = img.naturalWidth;
                                    const imgHeight = img.naturalHeight;
                                    const pageFormat = imgWidth > imgHeight ? 'l' : 'p';

                                    const pdfPageWidth = pdf.internal.pageSize.getWidth();
                                    const pdfPageHeight = pdf.internal.pageSize.getHeight();

                                    let newImgWidth = imgWidth;
                                    let newImgHeight = imgHeight;
                                    let ratio = imgWidth / imgHeight;

                                    if (newImgWidth > pdfPageWidth) {
                                        newImgWidth = pdfPageWidth;
                                        newImgHeight = newImgWidth / ratio;
                                    }
                                    if (newImgHeight > pdfPageHeight) {
                                        newImgHeight = pdfPageHeight;
                                        newImgWidth = newImgHeight * ratio;
                                    }
                                     // Re-check width if height scaling made it too wide again
                                    if (newImgWidth > pdfPageWidth) {
                                        newImgWidth = pdfPageWidth;
                                        newImgHeight = newImgWidth / ratio;
                                    }


                                    const x = (pdfPageWidth - newImgWidth) / 2;
                                    const y = (pdfPageHeight - newImgHeight) / 2;

                                    if (i > 0) pdf.addPage([pdfPageWidth, pdfPageHeight], pageFormat === 'l' ? 'landscape' : 'portrait');
                                    else pdf.setPage(1); // Ensure first page matches orientation if needed, though jsPDF usually handles aspect ratio.

                                    pdf.addImage(img, 'JPEG', x, y, newImgWidth, newImgHeight);
                                    resolve();
                                };
                                img.onerror = (err) => { console.error("Image load error for PDF:", err); reject(err); };
                            });
                        }
                        processingMsg.textContent = 'Generating PDF...';
                        const pdfBlob = pdf.output('blob');
                        const pdfUrl = URL.createObjectURL(pdfBlob);
                        downloadLink.href = pdfUrl;
                        downloadLink.download = 'converted_images.pdf';
                        downloadLink.style.display = 'inline-block';
                        downloadMessage.style.display = 'block';
                        resultText.textContent = `${window.originalJpgsForPdf.length} JPG(s) converted to PDF. Size: ${formatBytes(pdfBlob.size)}`;
                        outputInfo.style.display = 'block';
                    } catch (error) {
                        console.error("Error converting JPGs to PDF:", error);
                        alert("An error occurred during PDF conversion. Please check console.");
                        resultText.textContent = 'Conversion failed.';
                        outputInfo.style.display = 'block';
                    } finally {
                        processingMsg.textContent = 'Processing...';
                        processingMsg.style.display = 'none';
                        convertBtn.disabled = window.originalJpgsForPdf.length === 0;
                    }
                });
            }

            // --- PDF to JPG ---
            function setupPdfToJpgUI(file, url) {
                const fileNameSpan = document.getElementById('pdfToJpgFileName');
                const fileSizeSpan = document.getElementById('pdfToJpgFileSize');
                const fileInfoDiv = document.getElementById('pdfToJpgFileInfo');
                const convertBtn = document.getElementById('convertToJpgsBtn');
                const outputInfo = document.getElementById('pdfToJpgOutputInfo');
                const resultText = document.getElementById('pdfToJpgResultText');
                const downloadLink = document.getElementById('pdfToJpgDownloadLink');
                const downloadMessage = document.getElementById('pdfToJpgDownloadMessage');


                fileNameSpan.textContent = file.name;
                fileSizeSpan.textContent = formatBytes(file.size);
                fileInfoDiv.style.display = 'block';
                convertBtn.disabled = false;
                outputInfo.style.display = 'none'; resultText.textContent = '';
                if(downloadLink.href && downloadLink.href.startsWith('blob:')) { try{URL.revokeObjectURL(downloadLink.href); }catch(e){}}
                downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';
            }
            function setupPdfToJpgListeners() {
                addDropZoneListeners('pdf-to-jpg', 'pdfToJpgDropZone', 'pdfToJpgFileInput', false, "application/pdf");
                const convertBtn = document.getElementById('convertToJpgsBtn');
                const processingMsg = document.getElementById('pdfToJpgProcessingMsg');
                const downloadLink = document.getElementById('pdfToJpgDownloadLink');
                const downloadMessage = document.getElementById('pdfToJpgDownloadMessage');
                const outputInfo = document.getElementById('pdfToJpgOutputInfo');
                const resultText = document.getElementById('pdfToJpgResultText');

                convertBtn.addEventListener('click', async () => {
                    if (!window.originalPdfForJpg) { alert("Please select a PDF file first."); return; }
                    convertBtn.disabled = true; processingMsg.style.display = 'block';
                    outputInfo.style.display = 'none';
                    if(downloadLink.href && downloadLink.href.startsWith('blob:')) { try{URL.revokeObjectURL(downloadLink.href); }catch(e){}}
                    downloadLink.style.display = 'none'; downloadMessage.style.display = 'none';

                    const file = window.originalPdfForJpg.file;
                    const arrayBuffer = await file.arrayBuffer();

                    try {
                        const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const numPages = pdfDoc.numPages;
                        const zip = new JSZip();
                        const quality = 0.9;

                        for (let i = 1; i <= numPages; i++) {
                            processingMsg.textContent = `Processing page ${i} of ${numPages}...`;
                            const page = await pdfDoc.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;
                            const jpgBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
                            zip.file(`page_${i}.jpg`, jpgBlob);
                        }
                        processingMsg.textContent = 'Zipping files...';
                        const zipBlob = await zip.generateAsync({ type: "blob" });
                        const zipUrl = URL.createObjectURL(zipBlob);
                        downloadLink.href = zipUrl;
                        downloadLink.download = `${file.name.replace(/\.pdf$/i, '')}_jpgs.zip`;
                        downloadLink.style.display = 'inline-block';
                        downloadMessage.style.display = 'block';
                        resultText.textContent = `${numPages} page(s) converted to JPGs and zipped. Size: ${formatBytes(zipBlob.size)}`;
                        outputInfo.style.display = 'block';
                    } catch (error) {
                        console.error("Error converting PDF to JPGs:", error);
                        alert("An error occurred during PDF to JPG conversion. PDF might be encrypted or corrupted. Please check console.");
                        resultText.textContent = 'Conversion failed.';
                        outputInfo.style.display = 'block';
                    } finally {
                        processingMsg.textContent = 'Processing PDF...';
                        processingMsg.style.display = 'none';
                        convertBtn.disabled = !window.originalPdfForJpg;
                    }
                });
            }

            setupImageCompressorListeners();
            setupImageResizerListeners();
            setupImageConverterListeners();
            setupImageCropperListeners();
            setupImageRotateFlipListeners();
            setupImageFiltersListeners();
            setupJpgToPdfListeners();
            setupPdfToJpgListeners();

            handleNavigation();
            window.addEventListener('hashchange', handleNavigation);
            navLinks.forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const targetHash = anchor.getAttribute('href');
                    if (targetHash && targetHash.startsWith('#')) {
                        if (window.location.hash !== targetHash) {
                            e.preventDefault(); window.location.hash = targetHash;
                        } else {
                            if (targetHash !== '#homepage-section') {
                                const targetSection = document.getElementById(targetHash.substring(1));
                                if (targetSection) {
                                    e.preventDefault();
                                    const headerHeight = document.querySelector('header')?.offsetHeight || 60;
                                    window.scrollTo({ top: Math.max(0, targetSection.offsetTop - headerHeight), behavior: 'smooth' });
                                }
                            }
                        }
                    }
                });
            });

            window.addEventListener('beforeunload', () => {
                const urlsToRevoke = new Set();
                document.querySelectorAll('img[src^="blob:"]').forEach(img => { if(img.src) urlsToRevoke.add(img.src); });
                document.querySelectorAll('a[href^="blob:"]').forEach(a => { if(a.href) urlsToRevoke.add(a.href); });
                [originalCompressImage, originalResizeImage, originalConvertImage, originalCropImage, originalRotateFlipImage, currentRotateFlipImage, originalFilterImage].forEach(imgObj => {
                     if (imgObj && typeof imgObj.src === 'string' && imgObj.src.startsWith('blob:')) { urlsToRevoke.add(imgObj.src); }
                });
                window.originalJpgsForPdf.forEach(fileObj => {
                    if (fileObj.url && fileObj.url.startsWith('blob:')) { urlsToRevoke.add(fileObj.url); }
                });
                if(window.originalPdfForJpg && window.originalPdfForJpg.url && window.originalPdfForJpg.url.startsWith('blob:')) {
                    urlsToRevoke.add(window.originalPdfForJpg.url);
                }
                urlsToRevoke.forEach(url => { try { URL.revokeObjectURL(url); } catch (e) {} });
            });
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                 contactForm.addEventListener('submit', function(e) {
                     if (contactForm.action === window.location.href + '#contactForm' || contactForm.action === '#' || contactForm.action === window.location.href) {
                          e.preventDefault();
                          alert("The contact form is not yet configured to send messages.");
                     }
                 });
            }
        });
    </script>
</body>
</html>
